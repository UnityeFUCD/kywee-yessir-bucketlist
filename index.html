<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>kywee + yessir bucket list</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');

    :root {
      --bg: #000;
      --bg-card: #0a0a0a;
      --text: #ffffff;
      --muted: #94a3a3;
      --accent: #d4ff00;
      --accent-dim: #9ac000;
      --accent-secondary: #00ffd5;
      --border: #223;
      --border-bright: #d4ff00;
      --shadow: 0 0 40px rgba(212,255,0,.12);
      --danger: #ff4d4d;
      --ok: #4dff9a;
    }

    [data-theme="light"] {
      --bg: #f5f5f5;
      --bg-card: #ffffff;
      --text: #1a1a1a;
      --muted: #666;
      --accent: #111;
      --accent-dim: #333;
      --accent-secondary: #555;
      --border: #ddd;
      --border-bright: #aaa;
      --shadow: 0 2px 15px rgba(0,0,0,.1);
      --danger: #c91f1f;
      --ok: #128a52;
    }

    [data-theme="christmas"] {
      --bg: #0f1e14;
      --bg-card: #1a2e1f;
      --text: #ffffff;
      --muted: #a8b5ac;
      --accent: #e74c3c;
      --accent-dim: #c0392b;
      --accent-secondary: #27ae60;
      --border: #2d4a35;
      --border-bright: #4a7c59;
      --shadow: 0 4px 20px rgba(231,76,60,.2);
      --danger: #ff6a5f;
      --ok: #5dffb3;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Roboto Mono', monospace;
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      overflow-x:hidden;
      transition: background-color .25s ease, color .25s ease;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0,0,0,.12),
        rgba(0,0,0,.12) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events:none;
      z-index:999;
      opacity:0;
      transition: opacity .2s ease;
    }
    [data-theme="christmas"] body::before,
    :root body::before { opacity:.14; }
    [data-theme="light"] body::before { opacity:0; }

    .wrap{ width:min(1100px,94vw); margin:0 auto; padding:20px 0 80px; position:relative; z-index:2; }

    /* Topbar */
    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      padding:16px 20px;
      border:2px solid var(--border-bright);
      background:var(--bg);
      box-shadow:var(--shadow);
      position:sticky; top:14px;
      z-index:60;
      text-transform:uppercase;
      font-weight:700;
      letter-spacing:1px;
    }
    .brand{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; font-size:13px; }
    .topbar-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .pill{
      font-size:11px;
      padding:6px 12px;
      border:1px solid var(--border-bright);
      color:var(--accent);
      background:var(--bg);
      display:inline-flex; align-items:center; gap:8px;
    }
    .syncDot{ width:8px; height:8px; border-radius:999px; background:var(--danger); box-shadow:0 0 12px rgba(255,77,77,.35); }
    .syncDot.on{ background:var(--ok); box-shadow:0 0 12px rgba(77,255,154,.35); }

    /* Buttons */
    .btn{
      border:2px solid var(--border);
      background:var(--bg);
      color:var(--text);
      padding:10px 16px;
      cursor:pointer;
      font-weight:700;
      text-transform:uppercase;
      font-size:11px;
      letter-spacing:1px;
      transition:.15s ease;
      font-family:'Roboto Mono', monospace;
    }
    .btn:hover{ border-color:var(--accent); color:var(--accent); box-shadow:0 0 18px rgba(255,255,255,.06); }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#000; }
    .btn.primary:hover{ background:var(--accent-dim); border-color:var(--accent-dim); color:#000; }

    .hidden{ display:none !important; }

    /* Theme switcher */
    .theme-switcher{ position:relative; display:inline-block; }
    .theme-dropdown{
      position:absolute; top:calc(100% + 8px); right:0;
      background:var(--bg-card);
      border:2px solid var(--border-bright);
      box-shadow:var(--shadow);
      min-width:180px;
      z-index:120;
      display:none;
      overflow:hidden;
    }
    .theme-dropdown.active{ display:block; }
    .theme-option{
      padding:12px 16px;
      cursor:pointer;
      border-bottom:1px solid var(--border);
      font-size:11px;
      transition:.15s ease;
    }
    .theme-option:last-child{ border-bottom:none; }
    .theme-option:hover{ background:var(--accent); color:#000; }
    .theme-option.active{ background:rgba(255,255,255,.06); color:var(--accent); font-weight:700; }

    /* Bell + dropdown */
    .notificationWrap{ position:relative; }
    .notification-bell{
      width:26px; height:26px;
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      border:2px solid var(--border);
      background:var(--bg);
      transition:.15s ease;
    }
    .notification-bell:hover{ border-color:var(--accent); }
    .notification-bell svg{ width:18px; height:18px; fill:var(--text); }
    .notification-bell:hover svg{ fill:var(--accent); }
    .notification-badge{
      position:absolute;
      top:-6px; right:-6px;
      background:var(--accent);
      color:#000;
      font-size:9px;
      font-weight:700;
      padding:2px 6px;
      border-radius:12px;
      min-width:18px;
      text-align:center;
      border:2px solid var(--bg);
    }
    .notification-dropdown{
      position:absolute; top:calc(100% + 8px); right:0;
      background:var(--bg-card);
      border:2px solid var(--border-bright);
      box-shadow:var(--shadow);
      min-width:290px;
      max-width:360px;
      z-index:200;
      display:none;
      max-height:420px;
      overflow:auto;
    }
    .notification-dropdown.active{ display:block; }
    .notification-header{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:700;
      color:var(--accent);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .notification-item{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      transition:.15s ease;
    }
    .notification-item:last-child{ border-bottom:none; }
    .notification-item.unread{
      background:rgba(255,255,255,.04);
      border-left:3px solid var(--accent);
    }
    .notification-item:hover{ background:rgba(255,255,255,.06); }
    .nFrom{ font-size:10px; color:var(--accent); font-weight:700; margin-bottom:4px; }
    .nText{ font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nTime{ font-size:9px; color:var(--muted); margin-top:6px; }

    /* Cover */
    .cover{
      margin-top:26px;
      border:2px solid var(--border-bright);
      background:var(--bg-card);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .cover::before{
      content:"";
      position:absolute; top:0; left:0; right:0;
      height:3px;
      background:var(--accent);
      box-shadow:0 0 14px var(--accent);
    }
    .coverInner{
      padding:64px 30px 44px;
      text-align:center;
      border:1px solid var(--border);
      margin:10px;
      position:relative;
      z-index:2;
    }
    .big{
      font-size: clamp(30px, 5vw, 52px);
      margin:0 0 18px;
      line-height:1.05;
      text-transform:uppercase;
      font-weight:700;
      letter-spacing:2px;
    }
    .sub{
      color:var(--muted);
      font-size:14px;
      max-width:70ch;
      margin:0 auto 24px;
      line-height:1.6;
    }
    .heart{ width:60px; height:60px; margin:0 auto 24px; filter: drop-shadow(0 0 18px var(--accent)); }
    .row{ display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-top:24px; }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:28px; }

    /* Year progress */
    .year-progress{
      border:2px solid var(--border);
      background:var(--bg-card);
      box-shadow:var(--shadow);
      padding:20px;
      margin-top:20px;
    }
    .year-progress h3{
      margin:0 0 16px;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:1px;
      color:var(--accent);
    }
    .progress-stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
      margin-bottom:16px;
    }
    .stat-item{
      text-align:center;
      padding:12px;
      border:1px solid var(--border);
      background:var(--bg);
    }
    .stat-label{
      font-size:10px;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:6px;
      letter-spacing:.5px;
    }
    .stat-value{
      font-size:18px;
      font-weight:700;
      color:var(--accent);
    }
    .progress-bar-container{
      width:100%;
      height:24px;
      background:var(--bg);
      border:2px solid var(--border);
      overflow:hidden;
    }
    .progress-bar{
      height:100%;
      background:linear-gradient(90deg,var(--accent),var(--accent-secondary));
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding-right:8px;
      transition: width .35s ease;
      width:0%;
    }
    .progress-percent{ font-size:11px; font-weight:700; color:#000; text-shadow:none; }

    /* Grid */
    .grid{ display:grid; grid-template-columns:1.1fr 0.9fr; gap:20px; margin-top:20px; }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
      .topbar{ position:static; }
    }

    .card{
      border:2px solid var(--border);
      background:var(--bg-card);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; top:0; left:0; right:0;
      height:2px;
      background:var(--accent);
      box-shadow:0 0 12px rgba(0,0,0,.2);
    }
    .cardHeader{
      padding:18px 20px;
      border-bottom:2px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.03);
    }
    .cardHeader h2{
      margin:0;
      font-size:16px;
      letter-spacing:1.5px;
      text-transform:uppercase;
    }
    .cardBody{ padding:20px; }
    .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      border-left:2px solid var(--accent);
      padding-left:12px;
    }

    /* Items */
    .items{ display:flex; flex-direction:column; gap:12px; margin-top:16px; }
    .item{
      border:1px solid var(--border);
      padding:14px;
      background:var(--bg);
      display:flex;
      gap:12px;
      align-items:flex-start;
      position:relative;
      transition:.15s ease;
    }
    .item:hover{ border-color:var(--accent); box-shadow:0 0 16px rgba(0,0,0,.25); }
    .item input[type="checkbox"]{ margin-top:3px; width:18px; height:18px; accent-color:var(--accent); cursor:pointer; }
    .itext{ flex:1; }
    .ititle{
      margin:0;
      font-weight:700;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:10px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .itag{
      font-size:10px;
      padding:4px 8px;
      border:1px solid var(--accent);
      color:var(--accent);
      background:rgba(255,255,255,.03);
      text-transform:uppercase;
      font-weight:700;
      letter-spacing:.5px;
    }
    .idesc{ margin:8px 0 0; color:var(--muted); font-size:12px; line-height:1.4; }

    /* Form */
    .form{ display:flex; flex-direction:column; gap:14px; margin-top:16px; }
    label{ font-size:11px; color:var(--accent); text-transform:uppercase; letter-spacing:1px; font-weight:700; }
    input[type="text"], textarea{
      width:100%;
      padding:12px 14px;
      border:2px solid var(--border);
      background:var(--bg);
      color:var(--text);
      outline:none;
      font-family:'Roboto Mono', monospace;
      font-size:13px;
      transition:.15s ease;
    }
    input[type="text"]:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 12px rgba(0,0,0,.25);
    }
    textarea{ min-height:90px; resize:vertical; }
    .actionsRow{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    hr{ border:none; border-top:1px solid var(--border); margin:24px 0; }
    .footer{ margin-top:24px; text-align:center; color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:1px; }

    /* Message list (scroll after ~3 items) */
    .messageList{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:260px;
      overflow:auto;
      padding-right:6px;
    }
    .msg{
      border:1px solid var(--border);
      background:var(--bg);
      padding:12px;
    }
    .msgHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-size:10px; text-transform:uppercase; letter-spacing:.8px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .msgFrom{ color:var(--accent); font-weight:700; }
    .msgText{ font-size:12px; line-height:1.45; color:var(--text); white-space:pre-wrap; }

    /* Cursor */
    .cursor{
      display:inline-block;
      width:10px;
      height:1em;
      background:var(--accent);
      margin-left:6px;
      animation: blink 1s infinite;
      vertical-align:-2px;
    }
    @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:0} }

    /* Snow (Christmas only) */
    .snowflake{
      position:fixed;
      top:-10px;
      font-size:14px;
      color:#fff;
      opacity:.85;
      pointer-events:none;
      animation: fall linear forwards;
      z-index:40;
      text-shadow: 0 0 10px rgba(255,255,255,.35);
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(360deg); opacity:.2; }
    }

    /* Christmas lights (more pronounced) */
    .christmasLights{
      position:absolute;
      top:0; left:0; right:0;
      height:70px;
      pointer-events:none;
      z-index:3;
      display:none;
    }
    [data-theme="christmas"] .christmasLights{ display:block; }

    .wire{
      position:absolute;
      top:22px; left:-10px; right:-10px;
      height:4px;
      background: linear-gradient(90deg, rgba(0,0,0,.8), rgba(0,0,0,.2), rgba(0,0,0,.8));
      border-radius:999px;
      box-shadow: 0 0 18px rgba(0,0,0,.35);
      opacity:.75;
    }
    .bulbs{
      position:absolute;
      top:8px; left:0; right:0;
      display:flex;
      justify-content:space-evenly;
      align-items:flex-start;
      padding:0 10px;
    }
    .bulb{
      width:16px; height:16px;
      border-radius:999px;
      position:relative;
      box-shadow:
        0 0 18px rgba(255,255,255,.25),
        0 0 40px rgba(255,255,255,.15);
      transform: translateY(10px);
      animation: twinkle 1.8s infinite ease-in-out;
    }
    .bulb::before{
      content:"";
      position:absolute;
      top:-10px; left:50%;
      width:2px; height:14px;
      background: rgba(0,0,0,.55);
      transform: translateX(-50%);
      border-radius:2px;
    }
    .bulb::after{
      content:"";
      position:absolute;
      inset:-18px;
      border-radius:999px;
      background: radial-gradient(circle, rgba(255,255,255,.25), transparent 60%);
      opacity:.9;
      filter: blur(2px);
    }
    @keyframes twinkle{
      0%,100%{ filter: brightness(1.05); }
      50%{ filter: brightness(1.55); }
    }
    .bulb:nth-child(1){ background:#ff3b30; animation-delay:.0s; }
    .bulb:nth-child(2){ background:#34c759; animation-delay:.2s; }
    .bulb:nth-child(3){ background:#0a84ff; animation-delay:.4s; }
    .bulb:nth-child(4){ background:#ffd60a; animation-delay:.6s; }
    .bulb:nth-child(5){ background:#bf5af2; animation-delay:.8s; }
    .bulb:nth-child(6){ background:#64d2ff; animation-delay:1.0s; }
    .bulb:nth-child(7){ background:#ff9f0a; animation-delay:1.2s; }
    .bulb:nth-child(8){ background:#30d158; animation-delay:1.4s; }

    /* Modals (in-site pairing + user selection) */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:500;
    }
    .modalOverlay.active{ display:flex; }

    .modal{
      width:min(520px, 96vw);
      background: var(--bg-card);
      border:2px solid var(--border-bright);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
    }
    .modalHeader h3{
      margin:0;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:1px;
      color:var(--accent);
    }
    .modalClose{
      border:2px solid var(--border);
      background:var(--bg);
      color:var(--text);
      cursor:pointer;
      padding:6px 10px;
      font-weight:700;
      text-transform:uppercase;
      font-size:10px;
    }
    .modalBody{ padding-top:12px; }
    .modalBody p{ margin:0 0 12px; font-size:11px; color:var(--muted); line-height:1.5; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .row2{ grid-template-columns:1fr; } }

    .radioRow{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
    .chip{
      border:2px solid var(--border);
      background:var(--bg);
      color:var(--text);
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      text-transform:uppercase;
      font-size:11px;
      letter-spacing:1px;
    }
    .chip.active{ border-color:var(--accent); color:var(--accent); box-shadow:0 0 18px rgba(0,0,0,.25); }

    .tiny{ font-size:10px; color:var(--muted); margin-top:8px; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <span>[▸] 2026 BUCKET_LIST.EXE</span>
        <span class="pill" id="progressPill">0/0 COMPLETE</span>
        <span class="pill" id="syncPill"><span class="syncDot" id="syncDot"></span><span id="syncText">SYNC: OFF</span></span>
      </div>

      <div class="topbar-right">
        <button class="btn hidden" id="btnHome">◂ HOME</button>

        <div class="notificationWrap">
          <div class="notification-bell" id="bellBtn" title="Notifications">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 22a2.2 2.2 0 0 0 2.2-2.2h-4.4A2.2 2.2 0 0 0 12 22zm7-6V11a7 7 0 0 0-5-6.71V3a2 2 0 1 0-4 0v1.29A7 7 0 0 0 5 11v5l-2 2v1h20v-1l-2-2z"/>
            </svg>
            <span class="notification-badge hidden" id="bellBadge">0</span>
          </div>
          <div class="notification-dropdown" id="bellDropdown">
            <div class="notification-header">
              <span>New messages</span>
              <button class="btn" style="padding:6px 10px;" id="btnMarkAllRead">MARK READ</button>
            </div>
            <div id="bellList"></div>
          </div>
        </div>

        <button class="btn" id="btnPair">PAIR</button>

        <div class="theme-switcher">
          <button class="btn" id="themeBtn">THEME</button>
          <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option" data-theme="system">SYSTEM</div>
            <div class="theme-option" data-theme="light">LIGHT</div>
            <div class="theme-option" data-theme="dark">DARK</div>
            <div class="theme-option" data-theme="christmas">CHRISTMAS</div>
          </div>
        </div>

        <button class="btn" id="btnExport">EXPORT .TXT</button>
        <button class="btn" id="btnPrint">PRINT</button>
        <button class="btn" id="btnReset">RESET</button>
      </div>
    </div>

    <!-- Year Progress Widget -->
    <div class="year-progress hidden" id="yearProgress">
      <h3>[▸] 2026 PROGRESS TRACKER</h3>
      <div class="progress-stats">
        <div class="stat-item">
          <div class="stat-label">Current Date/Time</div>
          <div class="stat-value" id="currentDateTime">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Time Remaining in 2026</div>
          <div class="stat-value" id="timeRemaining">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Days Elapsed</div>
          <div class="stat-value" id="daysElapsed">--</div>
        </div>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar">
          <span class="progress-percent" id="progressPercent">0%</span>
        </div>
      </div>
    </div>

    <!-- Cover -->
    <section class="cover" id="cover">
      <div class="christmasLights" aria-hidden="true">
        <div class="wire"></div>
        <div class="bulbs">
          <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
          <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
        </div>
      </div>

      <div class="coverInner">
        <svg class="heart" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 21s-7.2-4.6-9.7-8.9C.5 8.9 2.1 5.8 5.5 5.1c1.7-.3 3.4.3 4.5 1.6 1.1-1.3 2.8-1.9 4.5-1.6 3.4.7 5 3.8 3.2 7-2.5 4.3-9.7 8.9-9.7 8.9Z"
                fill="currentColor" stroke="currentColor" stroke-width="0.5" style="color: var(--accent);"/>
        </svg>

        <h1 class="big">SYSTEM MESSAGE:<br><span id="systemMessageText">MY LOVE</span><span class="cursor"></span></h1>
        <p class="sub" id="subtitleText">
          [INITIALIZING...] Welcome to your 2026 bucket list protocol. A collection of missions, memories, and moments to execute together. Status: READY TO DEPLOY.
        </p>

        <div class="row">
          <span class="pill">[ COMPILED WITH LOVE ]</span>
          <span class="pill" id="pairPill">[ PAIR: NOT SET ]</span>
          <span class="pill" id="userPill">[ YOU: NOT SET ]</span>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnOpen">▸ INITIALIZE SYSTEM</button>
          <button class="btn" id="btnEditSystem">EDIT SYSTEM MESSAGE</button>
        </div>

        <div class="tiny" id="tinyHint"></div>
      </div>
    </section>

    <!-- Main Content -->
    <section class="grid hidden" id="main">
      <div class="card">
        <div class="cardHeader">
          <h2>[▸] MISSION_LIST.LOG</h2>
          <span class="pill" id="yearPill">2026</span>
        </div>
        <div class="cardBody">
          <div class="note">// STATUS: Shared + saved to database. Check to mark complete.</div>
          <div class="items" id="items"></div>
          <div class="actionsRow">
            <button class="btn" id="btnAddSample">+ ADD 10 MISSIONS</button>
            <button class="btn" id="btnClearAdded">RESET TO DEFAULT</button>
          </div>

          <hr />

          <div class="note">// Add a custom mission (shared)</div>
          <div class="form">
            <div class="field">
              <label>[▸] TITLE</label>
              <input id="newTitle" type="text" placeholder="TITLE (e.g., 'Late-night dessert run')">
            </div>
            <div class="field">
              <label>[▸] DESCRIPTION</label>
              <input id="newDesc" type="text" placeholder="DESCRIPTION (e.g., 'Pick a new spot and rate it 1-10')">
            </div>
            <div class="field">
              <label>[▸] TAG</label>
              <input id="newTag" type="text" placeholder="TAG (e.g., 'date', 'travel', 'cozy')">
            </div>
            <div class="actionsRow">
              <button class="btn primary" id="btnAdd">+ ADD MISSION</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h2>[▸] MESSAGE_LOG</h2>
          <span class="pill" id="fromPill">FROM: ?</span>
        </div>
        <div class="cardBody">
          <p class="note" id="loveNote">
            // OBJECTIVE: Make 2026 the year of "us" — more moments, more adventures, more memories.
            All systems go. Let's make it count.
          </p>

          <div class="form">
            <div class="field">
              <label for="customNote">[▸] NEW MESSAGE</label>
              <textarea id="customNote" placeholder="// Enter your message here..."></textarea>
            </div>
            <button class="btn primary" id="btnSendMsg">SEND MESSAGE</button>
          </div>

          <div class="messageList" id="messageList"></div>

          <div class="footer">[ COMPILED FOR ONE SPECIAL PERSON ]</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Pair Modal -->
  <div class="modalOverlay" id="pairModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>PAIR SETUP</h3>
        <button class="modalClose" id="pairClose">X</button>
      </div>
      <div class="modalBody">
        <p>
          Enter a shared pair code (room). Example: <b>yasir-kylee</b>.  
          Tip: you can also share a link like <b>?room=yasir-kylee</b> so it auto-fills.
        </p>
        <div class="field">
          <label>PAIR CODE</label>
          <input id="pairInput" type="text" placeholder="yasir-kylee">
        </div>
        <div class="actionsRow">
          <button class="btn primary" id="pairSave">SAVE + CONNECT</button>
          <button class="btn" id="pairCancel">CANCEL</button>
        </div>
        <div class="tiny">
          This enables global syncing (system message, missions, messages) across devices.
        </div>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modalOverlay" id="userModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>WHO ARE YOU?</h3>
        <button class="modalClose" id="userClose">X</button>
      </div>
      <div class="modalBody">
        <p>Pick who is sending right now. This controls “FROM: …” and message sender.</p>

        <div class="radioRow">
          <button class="chip" id="chipYasir">Yasir</button>
          <button class="chip" id="chipKylee">Kylee</button>
          <button class="chip" id="chipCustom">Custom</button>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>NAME</label>
          <input id="userInput" type="text" placeholder="Yasir">
        </div>

        <div class="actionsRow">
          <button class="btn primary" id="userSave">SAVE</button>
          <button class="btn" id="userCancel">CANCEL</button>
        </div>

        <div class="tiny">
          Stored on this device only (so each device can be “Yasir” or “Kylee”).
        </div>
      </div>
    </div>
  </div>

  <!-- Edit System Message Modal -->
  <div class="modalOverlay" id="sysModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>EDIT SYSTEM MESSAGE</h3>
        <button class="modalClose" id="sysClose">X</button>
      </div>
      <div class="modalBody">
        <p>This is global (shared). Changing it updates for both of you across devices.</p>
        <div class="field">
          <label>SYSTEM MESSAGE</label>
          <input id="sysInput" type="text" placeholder="MERRY CHRISTMAS">
        </div>
        <div class="actionsRow">
          <button class="btn primary" id="sysSave">SAVE</button>
          <button class="btn" id="sysCancel">CANCEL</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     *  Storage / Defaults
     ***********************/
    const LS = {
      ROOM: "ky_room_v3",
      USER: "ky_user_v3",
      THEME: "ky_theme_v3",
      LOCAL_STATE: "ky_local_state_v3",
      SEEN: "ky_seen_msgs_v3"
    };

    const defaultItems = [
      { title:"Christmas lights drive + hot chocolate", desc:"Pick a neighborhood, make a playlist, and rate the lights.", tag:"cozy", done:false },
      { title:"One fancy date night", desc:"Dress up, take photos, and try somewhere new.", tag:"date", done:false },
      { title:"Cook one meal together from scratch", desc:"No shortcuts — we make it a whole moment.", tag:"home", done:false },
      { title:"Sunrise or sunset moment", desc:"Bring blankets + snacks and just sit.", tag:"simple", done:false },
      { title:"Mini road trip (1–2 days)", desc:"No stress, just vibes. We pick a place and go.", tag:"travel", done:false },
      { title:"Try something neither of us has done", desc:"A class, a hobby, anything — once.", tag:"new", done:false },
      { title:"Write each other a letter", desc:"Open it on a random day when we need it.", tag:"romantic", done:false },
      { title:"Movie night with rules", desc:"Pick a theme + snacks. Phones away.", tag:"cozy", done:false },
      { title:"Make a 'memory jar'", desc:"Little notes all year, open on New Year's.", tag:"tradition", done:false },
      { title:"One 'yes day'", desc:"We say yes to each other's ideas (within reason)", tag:"fun", done:false },
    ];

    const extraIdeas = [
      { title:"Picnic date", desc:"Blanket + fruit + pastries + a playlist.", tag:"date", done:false },
      { title:"Museum / art day", desc:"Pick favorites and buy one tiny souvenir.", tag:"day", done:false },
      { title:"Thrift-store challenge", desc:"Each other picks an outfit under $25.", tag:"fun", done:false },
      { title:"DIY photoshoot", desc:"Golden hour + phone camera + goofy poses.", tag:"memories", done:false },
      { title:"Try a new dessert spot", desc:"Rate it and build a 'top 10' list.", tag:"food", done:false },
      { title:"Game night", desc:"Winner chooses the next date idea.", tag:"cozy", done:false },
      { title:"Spa night at home", desc:"Face masks, massage, candles.", tag:"romantic", done:false },
      { title:"Make a shared playlist", desc:"Add songs all year long.", tag:"music", done:false },
      { title:"Plan a future trip", desc:"Even if it's small — we plan it together.", tag:"dream", done:false },
      { title:"Do one kind thing together", desc:"Volunteer or help someone, quietly.", tag:"heart", done:false },
    ];

    const DEFAULT_STATE = {
      meta: {
        systemMessage: "MY LOVE",
        _rev: 0,
        _updatedAt: 0
      },
      items: defaultItems,
      messages: [] // {id, from, text, ts}
    };

    const $ = (id) => document.getElementById(id);

    function safeJsonParse(s, fallback){
      try { return JSON.parse(s) ?? fallback; } catch { return fallback; }
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function makeId(){
      // good-enough ID for our use
      return "m_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
    }

    function getRoomFromUrl(){
      const u = new URL(location.href);
      const room = u.searchParams.get("room");
      return room ? room.trim() : "";
    }

    /***********************
     *  Netlify API calls
     *  (Secret key stays server-side)
     ***********************/
    async function apiGetRoom(room){
      const res = await fetch(`/.netlify/functions/room?room=${encodeURIComponent(room)}`, { method:"GET" });
      if (!res.ok) throw new Error("GET failed");
      return await res.json(); // {payload}
    }

    async function apiSaveRoom(room, payload){
      const res = await fetch(`/.netlify/functions/room`, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ room, payload })
      });
      if (!res.ok) throw new Error("POST failed");
      return await res.json(); // {payload}
    }

    /***********************
     *  App state
     ***********************/
    let roomCode = "";
    let currentUser = "";
    let state = DEFAULT_STATE;

    let pollTimer = null;
    let saveTimer = null;
    let isSaving = false;
    let lastSeenRev = 0;

    function loadLocalState(){
      const local = safeJsonParse(localStorage.getItem(LS.LOCAL_STATE), null);
      if (!local || typeof local !== "object") return structuredClone(DEFAULT_STATE);
      // minimal merge
      return {
        meta: { ...DEFAULT_STATE.meta, ...(local.meta || {}) },
        items: Array.isArray(local.items) ? local.items : structuredClone(DEFAULT_STATE.items),
        messages: Array.isArray(local.messages) ? local.messages : []
      };
    }

    function saveLocalState(){
      localStorage.setItem(LS.LOCAL_STATE, JSON.stringify(state));
    }

    function setSync(on){
      $("syncDot").classList.toggle("on", !!on);
      $("syncText").textContent = on ? "SYNC: ON" : "SYNC: OFF";
    }

    function seenSet(){
      return new Set(safeJsonParse(localStorage.getItem(LS.SEEN), []));
    }
    function saveSeen(set){
      localStorage.setItem(LS.SEEN, JSON.stringify(Array.from(set)));
    }

    /***********************
     *  Rendering
     ***********************/
    function updateHeaderPills(){
      $("pairPill").textContent = roomCode ? `[ PAIR: ${roomCode.toUpperCase()} ]` : "[ PAIR: NOT SET ]";
      $("userPill").textContent = currentUser ? `[ YOU: ${currentUser.toUpperCase()} ]` : "[ YOU: NOT SET ]";
      $("fromPill").textContent = `FROM: ${currentUser ? currentUser.toUpperCase() : "?"}`;
      $("systemMessageText").textContent = (state.meta.systemMessage || "MY LOVE").toUpperCase();

      const hintParts = [];
      if (!roomCode) hintParts.push("Tap PAIR to connect.");
      if (!currentUser) hintParts.push("Set who you are (Yasir/Kylee).");
      $("tinyHint").textContent = hintParts.join(" ");
    }

    function updateProgress(){
      const items = state.items || [];
      const done = items.filter(i => i.done).length;
      $("progressPill").textContent = `${done}/${items.length} COMPLETE`;
    }

    function renderItems(){
      const container = $("items");
      container.innerHTML = "";

      (state.items || []).forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <input type="checkbox" ${it.done ? "checked" : ""} aria-label="Mark done">
          <div class="itext">
            <div class="ititle">
              <span>${escapeHtml(it.title || "")}</span>
              <span class="itag">${escapeHtml(it.tag || "idea")}</span>
            </div>
            <p class="idesc">${escapeHtml(it.desc || "")}</p>
          </div>
          <button class="btn" style="padding:8px 12px;" title="Remove">[X]</button>
        `;

        const cb = el.querySelector("input");
        cb.addEventListener("change", () => {
          state.items[idx].done = cb.checked;
          bumpRevAndSave();
          updateProgress();
        });

        const rm = el.querySelector("button");
        rm.addEventListener("click", () => {
          state.items.splice(idx, 1);
          bumpRevAndSave();
          renderItems();
          updateProgress();
        });

        container.appendChild(el);
      });
    }

    function formatTime(ts){
      const d = new Date(ts);
      return d.toLocaleString([], { month:"2-digit", day:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }

    function renderMessages(){
      const list = $("messageList");
      list.innerHTML = "";

      const msgs = Array.isArray(state.messages) ? state.messages : [];
      msgs.slice().reverse().forEach((m) => {
        const el = document.createElement("div");
        el.className = "msg";
        el.innerHTML = `
          <div class="msgHead">
            <span class="msgFrom">FROM: ${escapeHtml((m.from || "?").toUpperCase())}</span>
            <span>${escapeHtml(formatTime(m.ts || Date.now()))}</span>
          </div>
          <div class="msgText">${escapeHtml(m.text || "")}</div>
        `;
        list.appendChild(el);
      });

      // notifications
      renderBell();
    }

    function renderBell(){
      const set = seenSet();
      const msgs = Array.isArray(state.messages) ? state.messages : [];
      const unread = msgs.filter(m => m.from && currentUser && m.from.toLowerCase() !== currentUser.toLowerCase())
                         .filter(m => !set.has(m.id));

      const badge = $("bellBadge");
      if (unread.length > 0){
        badge.classList.remove("hidden");
        badge.textContent = String(unread.length);
      } else {
        badge.classList.add("hidden");
      }

      const bellList = $("bellList");
      bellList.innerHTML = "";

      if (msgs.length === 0){
        bellList.innerHTML = `<div class="notification-item"><div class="nText">No messages yet.</div></div>`;
        return;
      }

      // show latest 12
      msgs.slice().reverse().slice(0, 12).forEach(m => {
        const isUnread = currentUser && m.from && m.from.toLowerCase() !== currentUser.toLowerCase() && !set.has(m.id);
        const item = document.createElement("div");
        item.className = "notification-item" + (isUnread ? " unread" : "");
        item.innerHTML = `
          <div class="nFrom">${escapeHtml((m.from || "?").toUpperCase())}</div>
          <div class="nText">${escapeHtml(m.text || "")}</div>
          <div class="nTime">${escapeHtml(formatTime(m.ts || Date.now()))}</div>
        `;
        item.addEventListener("click", () => {
          const seen = seenSet();
          seen.add(m.id);
          saveSeen(seen);
          renderBell();
        });
        bellList.appendChild(item);
      });
    }

    function renderAll(){
      updateHeaderPills();
      updateProgress();
      renderItems();
      renderMessages();
    }

    /***********************
     *  Theme + Snow
     ***********************/
    let snowTimer = null;

    function getSystemTheme(){
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    function loadTheme(){
      return localStorage.getItem(LS.THEME) || "system";
    }
    function saveTheme(t){
      localStorage.setItem(LS.THEME, t);
    }
    function applyTheme(pref){
      const actual = pref === "system" ? getSystemTheme() : pref;
      document.documentElement.setAttribute("data-theme", actual);

      // mark active option
      document.querySelectorAll(".theme-option").forEach(opt => {
        opt.classList.toggle("active", opt.dataset.theme === pref);
      });

      // snow only on christmas
      stopSnow();
      if (actual === "christmas") startSnow();
    }

    function startSnow(){
      if (snowTimer) return;
      snowTimer = setInterval(() => {
        const s = document.createElement("div");
        s.className = "snowflake";
        s.textContent = Math.random() < 0.5 ? "❄" : "✦";
        s.style.left = (Math.random() * 100) + "vw";
        s.style.animationDuration = (6 + Math.random() * 8) + "s";
        s.style.fontSize = (10 + Math.random() * 12) + "px";
        s.style.opacity = (0.45 + Math.random() * 0.45);
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 15000);
      }, 220);
    }

    function stopSnow(){
      if (snowTimer){
        clearInterval(snowTimer);
        snowTimer = null;
      }
      document.querySelectorAll(".snowflake").forEach(x => x.remove());
    }

    /***********************
     *  Year progress clock
     ***********************/
    function updateYearProgress(){
      const now = new Date();
      const yearStart = new Date('2026-01-01T00:00:00');
      const yearEnd = new Date('2026-12-31T23:59:59');
      const totalMs = yearEnd - yearStart;

      const dateStr = now.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
      const timeStr = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
      $("currentDateTime").textContent = `${dateStr} ${timeStr}`;

      let progress = 0;
      if (now < yearStart){
        const daysUntil = Math.ceil((yearStart - now) / (1000 * 60 * 60 * 24));
        $("timeRemaining").textContent = `${daysUntil}d until 2026`;
        $("daysElapsed").textContent = "Not started";
        progress = 0;
      } else if (now > yearEnd){
        $("timeRemaining").textContent = "Year completed";
        $("daysElapsed").textContent = "365 days";
        progress = 100;
      } else {
        const elapsedMs = now - yearStart;
        const remainingMs = yearEnd - now;
        const days = Math.floor(remainingMs / (1000*60*60*24));
        const hours = Math.floor((remainingMs % (1000*60*60*24)) / (1000*60*60));
        const minutes = Math.floor((remainingMs % (1000*60*60)) / (1000*60));
        $("timeRemaining").textContent = `${days}d ${hours}h ${minutes}m`;

        const daysElapsed = Math.floor(elapsedMs / (1000*60*60*24));
        $("daysElapsed").textContent = `${daysElapsed} days`;

        progress = Math.min(100, Math.max(0, (elapsedMs / totalMs) * 100));
      }

      $("progressBar").style.width = progress + "%";
      $("progressPercent").textContent = progress.toFixed(1) + "%";
    }

    /***********************
     *  Sync logic (polling)
     ***********************/
    async function connectRoom(newRoom){
      roomCode = newRoom.trim();
      localStorage.setItem(LS.ROOM, roomCode);

      // update URL for easy sharing
      const u = new URL(location.href);
      u.searchParams.set("room", roomCode);
      history.replaceState({}, "", u.toString());

      $("pairInput").value = roomCode;
      updateHeaderPills();

      // load local first (fast)
      state = loadLocalState();
      renderAll();

      // now load remote
      try{
        setSync(false);
        const res = await apiGetRoom(roomCode);
        if (res && res.payload){
          state = normalizePayload(res.payload);
          saveLocalState();
          lastSeenRev = state.meta._rev || 0;
          renderAll();
          setSync(true);
        } else {
          // first time: push local state to remote
          bumpRev();
          const saved = await apiSaveRoom(roomCode, state);
          if (saved && saved.payload){
            state = normalizePayload(saved.payload);
            saveLocalState();
            lastSeenRev = state.meta._rev || 0;
          }
          renderAll();
          setSync(true);
        }
      } catch(e){
        console.error(e);
        setSync(false);
      }

      // start polling
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(pollOnce, 2500);
      $("pairPill").textContent = `[ PAIR: ${roomCode.toUpperCase()} ]`;
    }

    function normalizePayload(p){
      const meta = { ...DEFAULT_STATE.meta, ...(p.meta || {}) };
      const items = Array.isArray(p.items) ? p.items : structuredClone(DEFAULT_STATE.items);
      const messages = Array.isArray(p.messages) ? p.messages : [];
      return { meta, items, messages };
    }

    async function pollOnce(){
      if (!roomCode) return;
      try{
        const res = await apiGetRoom(roomCode);
        if (!res || !res.payload) return;
        const incoming = normalizePayload(res.payload);
        const incomingRev = incoming.meta._rev || 0;
        if (incomingRev > (state.meta._rev || 0)){
          state = incoming;
          saveLocalState();
          lastSeenRev = incomingRev;
          renderAll();
        }
        setSync(true);
      } catch(e){
        setSync(false);
      }
    }

    function bumpRev(){
      state.meta._rev = (state.meta._rev || 0) + 1;
      state.meta._updatedAt = Date.now();
    }

    function bumpRevAndSave(){
      bumpRev();
      saveLocalState();
      scheduleSave();
    }

    function scheduleSave(){
      if (!roomCode) return;
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        if (isSaving) return;
        isSaving = true;
        try{
          const saved = await apiSaveRoom(roomCode, state);
          if (saved && saved.payload){
            state = normalizePayload(saved.payload);
            saveLocalState();
            lastSeenRev = state.meta._rev || lastSeenRev;
          }
          setSync(true);
        } catch(e){
          setSync(false);
        } finally {
          isSaving = false;
        }
      }, 450);
    }

    /***********************
     *  Navigation
     ***********************/
    function openGift(){
      $("cover").classList.add("hidden");
      $("main").classList.remove("hidden");
      $("yearProgress").classList.remove("hidden");
      $("btnHome").classList.remove("hidden");
      renderAll();
    }
    function goHome(){
      $("cover").classList.remove("hidden");
      $("main").classList.add("hidden");
      $("yearProgress").classList.add("hidden");
      $("btnHome").classList.add("hidden");
    }

    /***********************
     *  Modals
     ***********************/
    function openModal(id){ $(id).classList.add("active"); }
    function closeModal(id){ $(id).classList.remove("active"); }

    function ensureUser(){
      if (!currentUser){
        openUserModal();
      }
    }

    function openUserModal(){
      openModal("userModal");
      const stored = localStorage.getItem(LS.USER) || "";
      $("userInput").value = stored || "";
      setChipActive(null);
      if (stored.toLowerCase() === "yasir") setChipActive("yasir");
      if (stored.toLowerCase() === "kylee") setChipActive("kylee");
    }

    function setChipActive(which){
      $("chipYasir").classList.toggle("active", which === "yasir");
      $("chipKylee").classList.toggle("active", which === "kylee");
      $("chipCustom").classList.toggle("active", which === "custom");
    }

    /***********************
     *  Events
     ***********************/
    $("btnOpen").addEventListener("click", () => {
      if (!roomCode) openModal("pairModal");
      ensureUser();
      openGift();
    });

    $("btnHome").addEventListener("click", goHome);
    $("btnPrint").addEventListener("click", () => window.print());

    $("btnReset").addEventListener("click", () => {
      // shared reset
      state.items = (state.items || []).map(it => ({ ...it, done:false }));
      bumpRevAndSave();
      renderItems();
      updateProgress();
    });

    $("btnAdd").addEventListener("click", () => {
      const title = $("newTitle").value.trim();
      const desc = $("newDesc").value.trim();
      const tag = $("newTag").value.trim() || "idea";
      if (!title) return alert("Add a title first");

      state.items = Array.isArray(state.items) ? state.items : [];
      state.items.unshift({ title, desc, tag, done:false });

      $("newTitle").value = "";
      $("newDesc").value = "";
      $("newTag").value = "";

      bumpRevAndSave();
      renderItems();
      updateProgress();
    });

    $("btnClearAdded").addEventListener("click", () => {
      state.items = structuredClone(defaultItems);
      bumpRevAndSave();
      renderItems();
      updateProgress();
    });

    $("btnAddSample").addEventListener("click", () => {
      const items = Array.isArray(state.items) ? state.items : [];
      const titles = new Set(items.map(i => i.title));
      extraIdeas.forEach(i => { if (!titles.has(i.title)) items.push(i); });
      state.items = items;
      bumpRevAndSave();
      renderItems();
      updateProgress();
    });

    $("btnSendMsg").addEventListener("click", () => {
      ensureUser();
      const text = $("customNote").value.trim();
      if (!text) return;

      state.messages = Array.isArray(state.messages) ? state.messages : [];
      state.messages.push({ id: makeId(), from: currentUser, text, ts: Date.now() });
      $("customNote").value = "";

      bumpRevAndSave();
      renderMessages();
    });

    $("btnExport").addEventListener("click", () => {
      const done = (x) => x.done ? "[X]" : "[ ]";
      const itemsTxt = (state.items || [])
        .map(i => `${done(i)} ${i.title} — ${i.desc} (#${i.tag})`)
        .join("\n");

      const msgsTxt = (state.messages || [])
        .slice()
        .reverse()
        .map(m => `FROM: ${m.from} @ ${formatTime(m.ts)}\n${m.text}\n---`)
        .join("\n");

      const text =
`kywee + yessir bucket list - 2026
ROOM: ${roomCode || "(not set)"}
USER: ${currentUser || "(not set)"}
SYSTEM MESSAGE: ${(state.meta.systemMessage || "MY LOVE")}

MISSIONS
====================
${itemsTxt || "(none)"}

MESSAGES
====================
${msgsTxt || "(none)"}
`;
      const blob = new Blob([text], { type:"text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `kywee-yessir-bucket-list-2026-${(roomCode||"room")}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Pair button opens modal
    $("btnPair").addEventListener("click", () => openModal("pairModal"));
    $("pairClose").addEventListener("click", () => closeModal("pairModal"));
    $("pairCancel").addEventListener("click", () => closeModal("pairModal"));
    $("pairSave").addEventListener("click", async () => {
      const val = $("pairInput").value.trim();
      if (!val) return alert("Enter a pair code");
      closeModal("pairModal");
      await connectRoom(val);
    });

    // User modal controls
    $("chipYasir").addEventListener("click", () => { setChipActive("yasir"); $("userInput").value = "Yasir"; });
    $("chipKylee").addEventListener("click", () => { setChipActive("kylee"); $("userInput").value = "Kylee"; });
    $("chipCustom").addEventListener("click", () => { setChipActive("custom"); $("userInput").focus(); });

    $("userClose").addEventListener("click", () => closeModal("userModal"));
    $("userCancel").addEventListener("click", () => closeModal("userModal"));
    $("userSave").addEventListener("click", () => {
      const name = $("userInput").value.trim();
      if (!name) return alert("Enter your name");
      currentUser = name;
      localStorage.setItem(LS.USER, currentUser);
      closeModal("userModal");
      updateHeaderPills();
      renderBell();
    });

    // Edit system message (GLOBAL)
    $("btnEditSystem").addEventListener("click", () => {
      $("sysInput").value = state.meta.systemMessage || "";
      openModal("sysModal");
    });
    $("sysClose").addEventListener("click", () => closeModal("sysModal"));
    $("sysCancel").addEventListener("click", () => closeModal("sysModal"));
    $("sysSave").addEventListener("click", () => {
      const msg = $("sysInput").value.trim();
      if (!msg) return alert("Enter a system message");
      state.meta.systemMessage = msg.toUpperCase();
      bumpRevAndSave();
      closeModal("sysModal");
      updateHeaderPills();
    });

    // Theme switcher
    $("themeBtn").addEventListener("click", () => $("themeDropdown").classList.toggle("active"));
    document.querySelectorAll(".theme-option").forEach(opt => {
      opt.addEventListener("click", () => {
        const theme = opt.dataset.theme;
        saveTheme(theme);
        applyTheme(theme);
        $("themeDropdown").classList.remove("active");
      });
    });

    // Close dropdowns on outside click
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".theme-switcher")) $("themeDropdown").classList.remove("active");
      if (!e.target.closest(".notificationWrap")) $("bellDropdown").classList.remove("active");
    });

    // Bell dropdown
    $("bellBtn").addEventListener("click", () => $("bellDropdown").classList.toggle("active"));
    $("btnMarkAllRead").addEventListener("click", () => {
      const set = seenSet();
      (state.messages || []).forEach(m => set.add(m.id));
      saveSeen(set);
      renderBell();
    });

    // system theme change listener
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if ((loadTheme() || "system") === "system") applyTheme("system");
    });

    /***********************
     *  Init
     ***********************/
    (function init(){
      // theme
      applyTheme(loadTheme());

      // load local fast
      state = loadLocalState();
      renderAll();

      // room from URL or local storage
      const urlRoom = getRoomFromUrl();
      roomCode = urlRoom || (localStorage.getItem(LS.ROOM) || "");
      if (roomCode){
        $("pairInput").value = roomCode;
        connectRoom(roomCode);
      } else {
        openModal("pairModal");
      }

      // user
      currentUser = localStorage.getItem(LS.USER) || "";
      if (!currentUser) openUserModal();

      updateHeaderPills();

      // year progress
      updateYearProgress();
      setInterval(updateYearProgress, 60000);
    })();
  </script>
</body>
</html>
