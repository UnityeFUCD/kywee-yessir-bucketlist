<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>kywee + yessir bucket list</title>

  <!-- ✅ App icon + favicon (iOS + browsers) -->
  <link rel="apple-touch-icon" href="/app-icon.png">
  <link rel="icon" type="image/png" href="/app-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bucket List">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');

    :root {
      --bg: #0a0a0a;
      --bg-card: #141414;
      --text: #ffffff;
      --muted: #999999;
      --accent: #ff6b9d;
      --accent-dim: #d4587e;
      --accent-secondary: #7b68ee;
      --border: #333333;
      --border-bright: #555555;
      --shadow: 0 0 40px rgba(255,107,157,.15);
    }

    [data-theme="light"] {
      --bg: #f5f5f5;
      --bg-card: #ffffff;
      --text: #1a1a1a;
      --muted: #666666;
      --accent: #e91e63;
      --accent-dim: #c2185b;
      --accent-secondary: #673ab7;
      --border: #e0e0e0;
      --border-bright: #bdbdbd;
      --shadow: 0 2px 15px rgba(0,0,0,.1);
    }

    [data-theme="dark"] {
      --bg: #000000;
      --bg-card: #0a0a0a;
      --text: #ffffff;
      --muted: #999999;
      --accent: #d4ff00;
      --accent-dim: #8fb300;
      --accent-secondary: #d4ff00;
      --border: #333333;
      --border-bright: #d4ff00;
      --shadow: 0 0 40px rgba(212,255,0,.15);
    }

    [data-theme="christmas"] {
      --bg: #0f1e14;
      --bg-card: #1a2e1f;
      --text: #ffffff;
      --muted: #a8b5ac;
      --accent: #e74c3c;
      --accent-dim: #c0392b;
      --accent-secondary: #27ae60;
      --border: #2d4a35;
      --border-bright: #4a7c59;
      --shadow: 0 4px 20px rgba(231,76,60,.2);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Roboto Mono', monospace;
      color: var(--text);
      min-height: 100vh;
      background: var(--bg);
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1),
        rgba(0, 0, 0, 0.1) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    [data-theme="dark"] body::before,
    [data-theme="christmas"] body::before {
      opacity: 0.15;
    }

    a { color: inherit; }

    .wrap {
      width: min(1100px, 94vw);
      margin: 0 auto;
      padding: 20px 0 80px;
      position: relative;
      z-index: 10; /* keeps snow behind UI */
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 16px 20px;
      border: 2px solid var(--border-bright);
      background: var(--bg);
      box-shadow: var(--shadow);
      position: sticky;
      top: 14px;
      z-index: 50;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: 1.5px;
      font-size: 13px;
      white-space: nowrap;
    }

    .topbar-right {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      font-size: 11px;
      padding: 6px 12px;
      border: 1px solid var(--border-bright);
      color: var(--accent);
      background: var(--bg);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: default;
    }

    .pill.clickable { cursor: pointer; }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    .dot.green { background: #3bff6b; box-shadow: 0 0 12px rgba(59,255,107,.35); }
    .dot.yellow { background: #ffe93b; box-shadow: 0 0 12px rgba(255,233,59,.35); }
    .dot.red { background: #ff3b3b; box-shadow: 0 0 12px rgba(255,59,59,.35); }
    .dot.gray { background: rgba(255,255,255,.25); box-shadow: none; }

    .dot.pulse {
      animation: pulseDot 1.1s infinite ease-in-out;
    }

    @keyframes pulseDot {
      0%, 100% { transform: scale(1); opacity: .85; }
      50% { transform: scale(1.25); opacity: 1; }
    }

    .btn {
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--text);
      padding: 10px 16px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 1px;
      font-family: 'Roboto Mono', monospace;
    }

    .btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 20px rgba(255,107,157,.3);
    }

    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }

    .btn.primary:hover {
      background: var(--accent-dim);
      border-color: var(--accent-dim);
    }

    .theme-switcher {
      position: relative;
      display: inline-block;
    }

    .theme-btn {
      padding: 8px 12px;
      font-size: 11px;
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-bright);
      box-shadow: var(--shadow);
      min-width: 180px;
      z-index: 100;
      display: none;
    }

    .theme-dropdown.active { display: block; }

    .theme-option {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.15s ease;
    }

    .theme-option:last-child { border-bottom: none; }
    .theme-option:hover { background: var(--accent); color: #000; }
    .theme-option.active { background: rgba(255,107,157,.1); color: var(--accent); font-weight: 700; }

    /* ✅ wrapper class so mobile can align the bell cleanly */
    .notif-wrap { position: relative; }

    .notification-bell {
      position: relative;
      cursor: pointer;
      transition: all 0.15s ease;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .notification-bell svg {
      width: 20px;
      height: 20px;
      fill: var(--text);
      transition: fill 0.15s ease;
    }

    .notification-bell:hover svg { fill: var(--accent); }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: #000;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
    }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-bright);
      box-shadow: var(--shadow);
      min-width: 300px;
      max-width: 340px;
      z-index: 100;
      display: none;
      max-height: 420px;
      overflow-y: auto;
    }

    .notification-dropdown.active { display: block; }

    .notification-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .notif-head-actions {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .notif-mini-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--border);
      background: var(--bg);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .notif-mini-btn:hover { border-color: var(--accent); box-shadow: 0 0 14px rgba(255,107,157,.25); }

    .notif-mini-btn svg {
      width: 16px;
      height: 16px;
      fill: var(--muted);
      transition: fill 0.15s ease;
    }

    .notif-mini-btn:hover svg { fill: var(--accent); }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .notification-item:last-child { border-bottom: none; }
    .notification-item:hover { background: rgba(255,107,157,.05); }
    .notification-item.unread { background: rgba(255,107,157,.08); border-left: 3px solid var(--accent); }

    .notification-from { font-size: 10px; color: var(--accent); font-weight: 700; margin-bottom: 4px; }
    .notification-preview { font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .notification-time { font-size: 9px; color: var(--muted); margin-top: 6px; }

    .notification-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .cover {
      margin-top: 26px;
      border: 2px solid var(--border-bright);
      background: var(--bg-card);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .cover::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
      z-index: 20;
    }

    /* ✅ CHRISTMAS LIGHTS (brighter + real colored bulbs) */
    .christmas-lights {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 54px;
      display: none;
      align-items: center;
      justify-content: space-evenly;
      padding: 10px 18px 0;
      pointer-events: none;
      z-index: 80;
    }

    [data-theme="christmas"] .christmas-lights { display: flex; }

    .christmas-lights::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 18px;
      height: 2px;
      background: rgba(255,255,255,0.22);
      box-shadow: 0 0 10px rgba(255,255,255,0.08);
    }

    .christmas-lights::after {
      content: "";
      position: absolute;
      left: -8px;
      right: -8px;
      top: 16px;
      height: 2px;
      background: rgba(231,76,60,.98);
      box-shadow: 0 0 16px rgba(231,76,60,.65), 0 0 34px rgba(231,76,60,.35);
    }

    .light {
      position: relative;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: currentColor; /* ✅ real bulb fill */
      opacity: 1;
      box-shadow: 0 0 12px currentColor, 0 0 28px currentColor, 0 0 70px currentColor;
      animation: twinkleDot 1.9s infinite ease-in-out;
      transform: translateY(9px);
    }

    .light::after {
      content: "";
      position: absolute;
      inset: -14px;
      background: radial-gradient(circle, currentColor 0%, rgba(0,0,0,0) 70%);
      opacity: .75;
      filter: blur(3px);
    }

    .light:nth-child(1) { color: #ff3b3b; animation-delay: 0s; }
    .light:nth-child(2) { color: #3bff6b; animation-delay: 0.18s; }
    .light:nth-child(3) { color: #3b7bff; animation-delay: 0.36s; }
    .light:nth-child(4) { color: #ffe93b; animation-delay: 0.54s; }
    .light:nth-child(5) { color: #ff3bf7; animation-delay: 0.72s; }
    .light:nth-child(6) { color: #3bfff0; animation-delay: 0.9s; }
    .light:nth-child(7) { color: #ffe93b; animation-delay: 1.08s; }
    .light:nth-child(8) { color: #3bff6b; animation-delay: 1.26s; }
    .light:nth-child(9) { color: #ff3b3b; animation-delay: 1.44s; }

    @keyframes twinkleDot {
      0%, 100% { filter: brightness(1.15); opacity: .95; }
      50% { filter: brightness(1.9); opacity: 1; }
    }

    .coverInner {
      padding: 60px 30px 40px;
      text-align: center;
      border: 1px solid var(--border);
      margin: 10px;
      position: relative;
      z-index: 30;
    }

    .big {
      font-size: clamp(32px, 5vw, 52px);
      margin: 0 0 20px;
      line-height: 1;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .sub {
      color: var(--muted);
      font-size: 14px;
      max-width: 70ch;
      margin: 0 auto 24px;
      line-height: 1.6;
    }

    .emoticon-art {
      color: var(--accent);
      font-size: 10px;
      line-height: 1.2;
      margin: 20px auto;
      display: inline-block;
      font-family: monospace;
    }

    .heart {
      width: 60px;
      height: 60px;
      margin: 0 auto 24px;
      filter: drop-shadow(0 0 15px var(--accent));
      transition: filter 0.3s ease;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .topbar { position: static; }
    }

    /* ✅ Mobile topbar alignment fix (doesn't touch desktop) */
    @media (max-width: 620px) {
      .wrap { width: min(1100px, 96vw); }

      .topbar {
        flex-direction: column;
        align-items: stretch;
        padding: 14px;
        gap: 12px;
      }

      .brand {
        width: 100%;
        justify-content: center;
        text-align: center;
        font-size: 12px;
        white-space: normal;
      }

      .topbar-right {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        gap: 8px;
      }

      .topbar .pill,
      .topbar .btn {
        width: 100%;
        justify-content: center;
        text-align: center;
      }

      .notif-wrap {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .notification-bell {
        width: 44px;
        height: 44px;
        border: 1px solid var(--border-bright);
        background: var(--bg);
      }

      .notification-dropdown {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: min(92vw, 340px);
        max-width: 340px;
      }

      .theme-switcher { width: 100%; }
      .theme-btn { width: 100%; }

      .theme-dropdown {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: min(92vw, 220px);
      }
    }

    .card {
      border: 2px solid var(--border);
      background: var(--bg-card);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--accent);
    }

    .cardHeader {
      padding: 18px 20px;
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: rgba(255,107,157,.03);
      transition: all 0.3s ease;
    }

    .cardHeader h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      font-weight: 700;
    }

    .cardBody { padding: 20px; }

    .note {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      border-left: 2px solid var(--accent);
      padding-left: 12px;
    }

    .mission-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .mission-tab {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
      margin-bottom: -2px;
    }

    .mission-tab:hover { color: var(--accent); }
    .mission-tab.active { border-bottom-color: var(--accent); color: var(--accent); }

    .items {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .item {
      border: 1px solid var(--border);
      padding: 14px;
      background: var(--bg);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: all 0.15s ease;
      position: relative;
    }

    .item.example { opacity: 0.5; border-style: dashed; }

    .item::before {
      content: "";
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 2px;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .item:hover { border-color: var(--accent); box-shadow: 0 0 20px rgba(255,107,157,.2); }
    .item:hover::before { opacity: 1; }

    .item input[type="checkbox"] {
      margin-top: 3px;
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .itext { flex: 1; }

    .ititle {
      margin: 0;
      font-weight: 700;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .itag {
      font-size: 10px;
      padding: 4px 8px;
      border: 1px solid var(--accent);
      color: var(--accent);
      background: rgba(255,107,157,.05);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .idesc {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .form {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 11px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--text);
      outline: none;
      font-family: 'Roboto Mono', monospace;
      font-size: 13px;
      transition: all 0.15s ease;
    }

    select { cursor: pointer; }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(255,107,157,.2);
    }

    textarea { min-height: 90px; resize: vertical; }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    /* ✅ Export next to Add Saved Mission (nice on mobile too) */
    .actions.actions-inline { justify-content: flex-start; }
    @media (max-width: 620px) {
      .actions.actions-inline {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
      .actions.actions-inline .btn { width: 100%; }
    }

    hr { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

    .footer {
      margin-top: 24px;
      text-align: center;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hidden { display: none !important; }

    .cursor {
      display: inline-block;
      width: 10px;
      height: 1em;
      background: var(--accent);
      margin-left: 5px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0; }
    }

    .corner-decor { position: absolute; width: 20px; height: 20px; border: 2px solid var(--accent); z-index: 60; }
    .corner-decor.tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
    .corner-decor.tr { top: 10px; right: 10px; border-left: none; border-bottom: none; }
    .corner-decor.bl { bottom: 10px; left: 10px; border-right: none; border-top: none; }
    .corner-decor.br { bottom: 10px; right: 10px; border-left: none; border-top: none; }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: var(--bg-card);
      border: 2px solid var(--border-bright);
      box-shadow: var(--shadow);
      max-width: 760px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 30px;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 10px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
    }

    .modal-close {
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      transition: color 0.15s ease;
      user-select: none;
    }

    .modal-close:hover { color: var(--accent); }

    .saved-mission-card {
      border: 1px solid var(--border);
      padding: 14px;
      margin-bottom: 12px;
      background: var(--bg);
      position: relative;
    }

    .saved-mission-card.selected {
      border-color: var(--accent);
      background: rgba(255,107,157,.05);
    }

    .saved-mission-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .saved-mission-actions { display: flex; gap: 8px; }

    .envelope-container {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      transition: all 0.15s ease;
      user-select: none;
    }

    .envelope-container:hover { border-color: var(--accent); color: var(--accent); }

    .letter-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .letter-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .letter-envelope {
      width: 400px;
      max-width: 90vw;
      background: #c9b17a;
      border: 3px solid #8b7355;
      padding: 40px;
      position: relative;
      transform-origin: center;
      animation: envelopeOpen 0.5s ease forwards;
    }

    @keyframes envelopeOpen {
      from { transform: scale(0.8) rotateX(-10deg); opacity: 0; }
      to { transform: scale(1) rotateX(0deg); opacity: 1; }
    }

    .letter-paper {
      background: #f4ecd8;
      border: 2px solid #8b7355;
      padding: 30px;
      font-family: 'Roboto Mono', monospace;
      color: #2c2416;
      line-height: 1.6;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform-origin: top;
      animation: letterUnfold 0.5s ease 0.3s forwards;
      opacity: 0;
    }

    @keyframes letterUnfold {
      from { transform: scaleY(0); opacity: 0; }
      to { transform: scaleY(1); opacity: 1; }
    }

    .letter-from {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #666;
    }

    .letter-timestamp { font-size: 10px; color: #999; margin-bottom: 16px; }

    .letter-content {
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .letter-close {
      position: absolute;
      top: 10px; right: 10px;
      width: 30px; height: 30px;
      background: var(--bg);
      border: 2px solid var(--accent);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.15s ease;
      user-select: none;
    }

    .letter-close:hover { background: var(--accent); color: #000; }

    #messageLog {
      max-height: none;
      overflow: visible;
      scroll-behavior: smooth;
    }

    #messageLog.scroll {
      max-height: 290px;
      overflow-y: auto;
    }

    .message-log-item {
      border: 1px solid var(--border);
      padding: 12px;
      margin-bottom: 12px;
      background: var(--bg);
    }

    .message-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 10px;
      color: var(--muted);
      gap: 10px;
    }

    .message-log-content {
      font-size: 12px;
      line-height: 1.5;
      color: var(--text);
      white-space: pre-wrap;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      box-shadow: var(--shadow);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      z-index: 3000;
      animation: slideInToast 0.3s ease, slideOutToast 0.3s ease 2.7s;
      pointer-events: none;
    }

    @keyframes slideInToast {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutToast {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }

    .snowflake {
      position: fixed;
      top: -10px;
      font-size: 14px;
      opacity: 0.85;
      pointer-events: none;
      animation: fall linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
      z-index: 5;
    }

    @keyframes fall {
      to { transform: translateY(110vh) rotate(360deg); opacity: 0.25; }
    }

    .tracker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .tracker-grid { grid-template-columns: 1fr; }
    }

    .tracker-box {
      border: 1px solid var(--border);
      background: var(--bg);
      padding: 14px;
      position: relative;
      overflow: hidden;
    }

    .tracker-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .tracker-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      line-height: 1.2;
    }

    .tracker-bar {
      margin-top: 14px;
      height: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      position: relative;
      overflow: hidden;
    }

    .tracker-fill {
      height: 100%;
      width: 0%;
      background: var(--accent);
      box-shadow: 0 0 14px rgba(255,107,157,.25);
      transition: width 0.25s ease;
    }

    .who-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 700px) {
      .who-grid { grid-template-columns: 1fr; }
    }

    .who-btn {
      padding: 14px 16px;
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Roboto Mono', monospace;
      transition: all 0.15s ease;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .who-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 18px rgba(255,107,157,.25);
    }

    .who-sub {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.6;
      margin-top: 10px;
    }

    .who-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span>[▸] 2026 BUCKET_LIST.EXE</span>
      </div>

      <div class="topbar-right">
        <button class="btn hidden" id="btnHome">◂ HOME</button>

        <div class="notif-wrap">
          <div class="notification-bell" id="notificationBell" aria-label="Notifications" title="Notifications">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
            </svg>
            <span class="notification-badge hidden" id="notificationBadge">0</span>
          </div>

          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <span>MESSAGES</span>
              <div class="notif-head-actions">
                <button class="notif-mini-btn" id="btnNotifClearAll" title="Mark all read">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 7h10v2H7V7zm0 4h10v2H7v-2zm0 4h6v2H7v-2z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div id="notificationList"></div>
          </div>
        </div>

        <span class="pill clickable" id="userPill" title="Click to switch user">
          <span class="dot gray" id="userDot"></span>
          <span id="userText">USER: --</span>
        </span>

        <span class="pill" id="duoPill" title="Duo status">
          <span class="dot gray" id="duoDot"></span>
          <span id="duoText">DUO: --</span>
        </span>

        <span class="pill" id="syncPill" title="Sync status">
          <span class="dot gray" id="syncDot"></span>
          <span>SYNC</span>
        </span>

        <div class="theme-switcher">
          <button class="btn theme-btn" id="themeBtn">THEME</button>
          <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option active" data-theme="system">System</div>
            <div class="theme-option" data-theme="light">Light</div>
            <div class="theme-option" data-theme="dark">Dark</div>
            <div class="theme-option" data-theme="christmas">Christmas</div>
          </div>
        </div>
      </div>
    </div>

    <section class="cover" id="cover">
      <div class="christmas-lights">
        <div class="light"></div><div class="light"></div><div class="light"></div>
        <div class="light"></div><div class="light"></div><div class="light"></div>
        <div class="light"></div><div class="light"></div><div class="light"></div>
      </div>

      <div class="corner-decor tl"></div>
      <div class="corner-decor tr"></div>
      <div class="corner-decor bl"></div>
      <div class="corner-decor br"></div>

      <div class="coverInner">
        <svg class="heart" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 21s-7.2-4.6-9.7-8.9C.5 8.9 2.1 5.8 5.5 5.1c1.7-.3 3.4.3 4.5 1.6 1.1-1.3 2.8-1.9 4.5-1.6 3.4.7 5 3.8 3.2 7-2.5 4.3-9.7 8.9-9.7 8.9Z"
                fill="currentColor" stroke="currentColor" stroke-width="0.5" style="color: var(--accent);"/>
        </svg>

        <h1 class="big">SYSTEM MESSAGE:<br><span id="herName">MY LOVE</span><span class="cursor"></span></h1>

        <p class="sub">[INITIALIZING...] Our bucket list for the new year. Status: WEADY TO DEPLOY.</p>

        <pre class="emoticon-art">⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⠟⠿⣷⣦⡀⠀⠀⠀⠀⠀⠀⣀⣴⣿⠿⣷⣦⡀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣰⣿⠟⠀⠀⠀⠈⠻⣿⣦⣤⣤⣤⣤⣾⡿⠋⠁⠀⠈⠻⣿⣦⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢰⣿⠏⠀⠀⠀⠀⠀⠀⢸⠙⠉⢹⢉⢹⠉⠁⠀⠀⠀⠀⠀⠈⣿⡇⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣤⣤⣬⣷⣶⣶⣴⣶⣶⣶⣤⠀⣧⠀⣼⠘⢺⣤⣤⣴⣶⣶⣶⣶⣤⣭⣤⡀⠀⠀⠀⠀
⠀⠿⣷⣶⢽⣿⠉⠁⠀⠈⠉⠉⠉⠸⣿⠀⠀⠀⢀⣀⣸⣿⠉⠉⠉⠉⠉⠉⠉⠉⣿⣇⣴⣾⠿⠀
⣠⣴⣶⡦⢸⣿⠀⢀⣀⠀⠀⠀⠀⠀⣿⡿⠿⠿⠿⠟⢻⣿⠀⠀⠀⠀⢀⣀⠀⠀⣿⣿⣿⣥⣤⡀
⠈⠉⠁⠀⢸⣿⣀⣼⣿⣃⣤⣤⣤⣴⣿⡅⠀⠀⠀⠀⠸⣿⣦⣤⣤⣀⣸⣿⣀⣸⣿⠋⠉⠉⠛⠋
⠀⠀⠀⠀⣘⣟⡿⡋⠑⢽⠛⠉⠉⠉⠻⢿⣿⣿⡿⢿⣿⠏⠉⠉⠙⠛⠛⠛⠛⣻⣯⠀⠀⠀⠀⠀
⠀⢀⡖⠉⠉⠀⠠⠇⠀⠸⣶⣶⣶⣤⠀⢸⣿⣿⣷⣿⡏⠀⠀⠀⠀⢀⣀⣴⣾⡿⠋⠀⠀⠀⠀⠀
⠀⠘⢷⡀⠁⠀⠀⠀⠀⠀⢹⠀⠈⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⠛⢉⣿⡿⠀⠀⠀⠀⠀⠀
⠀⠀⠈⠱⣤⣀⠀⠀⢀⣠⡞⠀⠀⠀⠀⠀⠀⠀⠤⠀⠀⠀⠀⠀⠀⠀⣾⡿⠟⠁⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠈⠓⠒⠚⠁⣿⣇⢀⣀⣀⣀⣀⣀⣀⣐⣀⣀⣀⣤⣤⣄⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣿⣿⠟⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠉⠻⠿⠿⠃⠀⠀⠀⠀⠀⠀⠀⠀</pre>

        <div class="actions" style="justify-content:center; margin-top:30px;">
          <button class="btn primary" id="btnOpen">▸ INITIALIZE SYSTEM</button>
          <button class="btn" id="btnEditSystemMessage">EDIT SYSTEM MESSAGE</button>
        </div>
      </div>
    </section>

    <section class="grid hidden" id="main">
      <div class="card" style="grid-column: 1 / -1;">
        <div class="cardHeader">
          <h2>[▸] 2026 PROGRESS_TRACKER</h2>
          <span class="pill">2026</span>
        </div>
        <div class="cardBody">
          <div class="tracker-grid">
            <div class="tracker-box">
              <div class="tracker-label">CURRENT DATE/TIME</div>
              <div class="tracker-value" id="trackerNow">--</div>
            </div>
            <div class="tracker-box">
              <div class="tracker-label">TIME REMAINING</div>
              <div class="tracker-value" id="trackerRemaining">--</div>
            </div>
            <div class="tracker-box">
              <div class="tracker-label">DAYS ELAPSED</div>
              <div class="tracker-value" id="trackerElapsed">--</div>
            </div>
          </div>
          <div class="tracker-bar" aria-hidden="true">
            <div class="tracker-fill" id="trackerFill"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h2>[▸] MISSION_LIST.LOG</h2>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="pill" id="yearPill">2026</span>
          </div>
        </div>

        <div class="cardBody">
          <div class="mission-tabs">
            <div class="mission-tab active" data-tab="active">Active Missions</div>
            <div class="mission-tab" data-tab="completed">Completed Missions</div>
          </div>

          <div id="activeTab">
            <div class="note">// STATUS: Items are auto-saved. Check to mark complete.</div>
            <div class="items" id="itemsActive"></div>

            <!-- ✅ Export moved next to Add Saved Mission -->
            <div class="actions actions-inline">
              <button class="btn primary" id="btnAddSaved">ADD SAVED MISSION</button>
              <button class="btn" id="btnDownloadText">EXPORT .TXT</button>
            </div>
          </div>

          <div id="completedTab" class="hidden">
            <div class="note">// COMPLETED: Missions you've finished.</div>
            <div class="items" id="itemsCompleted"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h2>[▸] MESSAGE_LOG</h2>
          <div class="envelope-container" id="envelopeBtn" title="Open latest letter from your DUO">
            <span aria-hidden="true">✉</span>
            <span id="envelopeLabel">DUO</span>
          </div>
        </div>

        <div class="cardBody">
          <p class="note" id="loveNote">// SYSTEM MESSAGE: MY LOVE</p>

          <div id="messageLog"></div>

          <div class="form">
            <div class="field">
              <label for="customNote">[▸] NEW MESSAGE</label>
              <textarea id="customNote" placeholder="// Enter your message here..."></textarea>
            </div>
            <button class="btn primary" id="btnSaveNote">SEND LETTER</button>
          </div>

          <hr />

          <div class="field">
            <label>[▸] ADD NEW MISSION</label>
            <input id="newTitle" type="text" placeholder="Movie">
          </div>
          <div class="field">
            <input id="newDesc" type="text" placeholder="pick a movie and location">
          </div>
          <div class="field">
            <label for="newTag">TAG</label>
            <select id="newTag">
              <option value="date">date</option>
              <option value="travel">travel</option>
              <option value="cozy">cozy</option>
              <option value="food">food</option>
              <option value="home">home</option>
              <option value="romantic">romantic</option>
              <option value="fun">fun</option>
              <option value="tradition">tradition</option>
              <option value="music">music</option>
              <option value="new">new</option>
              <option value="heart">heart</option>
              <option value="custom">Custom...</option>
            </select>
          </div>
          <div class="field hidden" id="customTagField">
            <input id="customTagInput" type="text" placeholder="Enter custom tag">
          </div>
          <div class="actions">
            <button class="btn primary" id="btnAdd">+ ADD MISSION</button>
            <button class="btn" id="btnClearFields">CLEAR FIELDS</button>
          </div>

          <div class="footer">[ COMPILED FOR ONE SPECIAL KITTEN ]</div>
        </div>
      </div>
    </section>
  </div>

  <div class="modal" id="savedMissionsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Saved Missions Database</h3>
        <span class="modal-close" id="closeSavedModal">✖</span>
      </div>
      <div id="savedMissionsList"></div>
      <div class="actions">
        <button class="btn primary" id="btnAddSelectedMissions">ADD SELECTED TO ACTIVE</button>
      </div>
    </div>
  </div>

  <div class="letter-modal" id="letterModal">
    <div class="letter-envelope">
      <div class="letter-close" id="closeLetterModal">✖</div>
      <div class="letter-paper">
        <div class="letter-from">FROM: <span id="letterFrom">--</span></div>
        <div class="letter-timestamp" id="letterTimestamp"></div>
        <div class="letter-content" id="letterContent"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="whoModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3>WHO ARE YOU?</h3>
        <span class="modal-close" id="closeWhoModal">✖</span>
      </div>

      <div class="who-grid">
        <button class="who-btn" id="btnWhoYasir">
          <span>YASIR</span>
          <span class="itag">USER</span>
        </button>

        <button class="who-btn" id="btnWhoKylee">
          <span>KYLEE</span>
          <span class="itag">USER</span>
        </button>
      </div>

      <div class="who-sub">
        This site auto-syncs (system message, missions, messages) across devices.
      </div>

      <div class="who-actions">
        <button class="btn" id="btnLogOff">LOG OFF</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Local keys ----------
    const KEY_ACTIVE = "bucketlist_2026_active";
    const KEY_SAVED = "bucketlist_2026_saved";
    const KEY_COMPLETED = "bucketlist_2026_completed";
    const KEY_MESSAGES = "bucketlist_2026_messages";
    const KEY_CUSTOM_TAGS = "bucketlist_2026_custom_tags";
    const KEY_THEME = "bucketlist_2026_theme";
    const KEY_SYSTEM_MESSAGE = "bucketlist_2026_system_message";

    const KEY_USER = "bucketlist_2026_user";
    function keyLastRead(user) { return `bucketlist_2026_lastread_${String(user || "").toLowerCase()}`; }

    const ROOM_CODE = "yasir-kylee";
    const $ = (id) => document.getElementById(id);

    const exampleActive = { title: "Test Mission (Example)", desc: "This is an example card", tag: "example", done: false, isExample: true };
    const exampleCompleted = { title: "Test Completed (Example)", desc: "This is a completed example", tag: "example", done: true, isExample: true };

    let selectedSavedMissions = [];
    let currentTheme = "system";

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function formatDT(dt) {
      try {
        return dt.toLocaleString(undefined, {
          month: "short",
          day: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true
        }).replace(",", "");
      } catch {
        return String(dt);
      }
    }

    function loadUser() { return localStorage.getItem(KEY_USER) || ""; }
    function hasUser() { return !!loadUser().trim(); }
    function saveUser(name) { localStorage.setItem(KEY_USER, name); }

    function getDuoName(user) {
      const u = String(user || "").trim().toLowerCase();
      if (u === "yasir") return "Kylee";
      if (u === "kylee") return "Yasir";
      return "--";
    }

    function loadLastRead() {
      const u = loadUser();
      if (!u) return -1;
      const raw = localStorage.getItem(keyLastRead(u));
      const n = Number(raw);
      return Number.isFinite(n) ? n : -1;
    }

    function saveLastRead(n) {
      const u = loadUser();
      if (!u) return;
      localStorage.setItem(keyLastRead(u), String(n));
    }

    function loadArray(key) {
      try {
        const saved = JSON.parse(localStorage.getItem(key));
        return Array.isArray(saved) ? saved : [];
      } catch { return []; }
    }

    function saveArray(key, arr) {
      localStorage.setItem(key, JSON.stringify(arr));
      schedulePush();
    }

    function loadActive() { return loadArray(KEY_ACTIVE); }
    function saveActive(items) { saveArray(KEY_ACTIVE, items); }

    function loadSaved() { return loadArray(KEY_SAVED); }
    function saveSaved(items) { saveArray(KEY_SAVED, items); }

    function loadCompleted() { return loadArray(KEY_COMPLETED); }
    function saveCompleted(items) { saveArray(KEY_COMPLETED, items); }

    function loadMessages() { return loadArray(KEY_MESSAGES); }
    function saveMessages(msgs) { saveArray(KEY_MESSAGES, msgs); }

    function loadCustomTags() { return loadArray(KEY_CUSTOM_TAGS); }
    function saveCustomTags(tags) { saveArray(KEY_CUSTOM_TAGS, tags); }

    function loadTheme() { return localStorage.getItem(KEY_THEME) || "system"; }
    function saveTheme(theme) { localStorage.setItem(KEY_THEME, theme); }

    function loadSystemMessage() { return localStorage.getItem(KEY_SYSTEM_MESSAGE) || "My Love"; }
    function saveSystemMessageLocalOnly(msg) {
      localStorage.setItem(KEY_SYSTEM_MESSAGE, msg);
    }

    function renderSystemMessage(msg) {
      $("herName").textContent = String(msg).toUpperCase();
      $("loveNote").textContent = `// SYSTEM MESSAGE: ${String(msg).toUpperCase()}`;
    }

    function setDot(el, color, pulse=false) {
      el.classList.remove("green", "yellow", "red", "gray", "pulse");
      el.classList.add(color);
      if (pulse) el.classList.add("pulse");
    }

    function setSyncStatus(mode) {
      const dot = $("syncDot");
      if (mode === "pulling" || mode === "saving") setDot(dot, "yellow", true);
      else if (mode === "on") setDot(dot, "green", false);
      else if (mode === "error") setDot(dot, "red", false);
      else setDot(dot, "gray", false);
    }

    let presenceTimer = null;
    let lastPresence = null;

    function normalizePerson(name) {
      const n = String(name || "").trim().toLowerCase();
      if (n === "yasir") return "yasir";
      if (n === "kylee") return "kylee";
      return "";
    }

    function updateUserDuoPills() {
      const user = loadUser().trim();
      const duo = getDuoName(user);

      $("userText").textContent = user ? `USER: ${user.toUpperCase()}` : "USER: --";
      $("duoText").textContent = user ? `DUO: ${duo.toUpperCase()}` : "DUO: --";
      $("envelopeLabel").textContent = user ? `DUO: ${duo.toUpperCase()}` : "DUO";

      setDot($("userDot"), user ? "green" : "gray", false);

      if (!user || !lastPresence) {
        setDot($("duoDot"), "gray", false);
        return;
      }

      const duoKey = normalizePerson(duo);
      const ts = lastPresence?.[duoKey];
      if (!ts) {
        setDot($("duoDot"), "gray", false);
        return;
      }

      const t = new Date(ts).getTime();
      const age = Date.now() - t;
      if (Number.isFinite(age) && age <= 45000) setDot($("duoDot"), "green", false);
      else setDot($("duoDot"), "gray", false);
    }

    async function presencePing() {
      if (!hasUser()) return;
      try {
        const res = await remotePatchPresence(loadUser().trim());
        if (res?.presence) {
          lastPresence = res.presence;
          updateUserDuoPills();
        }
      } catch {}
    }

    function startPresence() {
      if (presenceTimer) return;
      presencePing();
      presenceTimer = setInterval(presencePing, 15000);
    }

    function stopPresence() {
      if (presenceTimer) {
        clearInterval(presenceTimer);
        presenceTimer = null;
      }
    }

    function duoUnreadIndexes(messages) {
      const user = loadUser().trim().toLowerCase();
      if (!user) return [];

      const lastRead = loadLastRead();
      const idxs = [];
      for (let i = 0; i < messages.length; i++) {
        const from = String(messages[i]?.from || "").trim().toLowerCase();
        if (from && from !== user && i > lastRead) idxs.push(i);
      }
      return idxs;
    }

    function markReadUpTo(index) {
      const cur = loadLastRead();
      const next = Math.max(cur, index);
      saveLastRead(next);
    }

    function adjustLastReadAfterDelete(deletedIndex) {
      const cur = loadLastRead();
      if (cur < 0) return;
      if (deletedIndex <= cur) saveLastRead(cur - 1);
    }

    function updateNotifications() {
      const messages = loadMessages();
      const badge = $("notificationBadge");
      const list = $("notificationList");

      const unreadIdxs = duoUnreadIndexes(messages);

      if (unreadIdxs.length > 0) {
        badge.textContent = unreadIdxs.length;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }

      list.innerHTML = "";

      if (!hasUser()) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted); font-size: 11px;">Pick USER first</div>';
        return;
      }

      const userLower = loadUser().trim().toLowerCase();
      const duoMsgs = messages
        .map((m, i) => ({ m, i }))
        .filter(x => String(x.m?.from || "").trim().toLowerCase() !== userLower);

      if (duoMsgs.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted); font-size: 11px;">No duo messages yet</div>';
        return;
      }

      const lastRead = loadLastRead();

      duoMsgs.slice().reverse().forEach(({ m, i }) => {
        const displayName = m.from || "Unknown";
        const isUnread = i > lastRead;

        const item = document.createElement("div");
        item.className = "notification-item" + (isUnread ? " unread" : "");
        item.innerHTML = `
          <div class="notification-from">FROM: ${escapeHtml(displayName)}</div>
          <div class="notification-preview">${escapeHtml(String(m.content || "").substring(0, 54))}${String(m.content || "").length > 54 ? "..." : ""}</div>
          <div class="notification-time">${escapeHtml(m.timestamp || "")}</div>

          <div class="notification-actions">
            <button class="notif-mini-btn" title="Mark read" data-action="read">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-2.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
              </svg>
            </button>
            <button class="notif-mini-btn" title="Delete" data-action="delete">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z"/>
              </svg>
            </button>
          </div>
        `;

        item.addEventListener("click", () => {
          openMessage(i);
          $("notificationDropdown").classList.remove("active");
        });

        item.querySelector('[data-action="read"]').addEventListener("click", (e) => {
          e.stopPropagation();
          markReadUpTo(i);
          updateNotifications();
          showToast("Marked read");
        });

        item.querySelector('[data-action="delete"]').addEventListener("click", async (e) => {
          e.stopPropagation();
          const messagesNow = loadMessages();
          messagesNow.splice(i, 1);
          adjustLastReadAfterDelete(i);
          saveMessages(messagesNow);
          renderMessages();
          updateNotifications();
          showToast("Deleted");
          await pushRemoteState();
        });

        list.appendChild(item);
      });
    }

    function openMessage(index) {
      const messages = loadMessages();
      const msg = messages[index];
      if (!msg) return;

      const displayName = msg.from || "Unknown";
      $("letterFrom").textContent = displayName.toUpperCase();
      $("letterTimestamp").textContent = msg.timestamp || "";
      $("letterContent").textContent = msg.content || "";

      const userLower = loadUser().trim().toLowerCase();
      const fromLower = String(msg.from || "").trim().toLowerCase();
      if (userLower && fromLower && fromLower !== userLower) {
        markReadUpTo(index);
        updateNotifications();
      }

      $("letterModal").classList.add("active");
    }

    function clearAllNotifications() {
      const messages = loadMessages();
      const userLower = loadUser().trim().toLowerCase();
      if (!userLower) return;

      let lastDuo = -1;
      for (let i = 0; i < messages.length; i++) {
        const from = String(messages[i]?.from || "").trim().toLowerCase();
        if (from && from !== userLower) lastDuo = i;
      }
      if (lastDuo >= 0) saveLastRead(lastDuo);
      updateNotifications();
      showToast("All read");
    }

    function renderActive() {
      const items = loadActive();
      const container = $("itemsActive");
      container.innerHTML = "";

      const withExample = [exampleActive, ...items];

      withExample.forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "item" + (it.isExample ? " example" : "");
        el.innerHTML = `
          <input type="checkbox" ${it.done ? "checked" : ""} ${it.isExample ? "disabled" : ""} aria-label="Mark done">
          <div class="itext">
            <div class="ititle">
              <span>${escapeHtml(it.title)}</span>
              <span class="itag">${escapeHtml(it.tag || "idea")}</span>
            </div>
            <p class="idesc">${escapeHtml(it.desc || "")}</p>
          </div>
          ${!it.isExample ? '<button class="btn" style="padding:8px 12px;" title="Remove">[X]</button>' : ""}
        `;

        if (!it.isExample) {
          const cb = el.querySelector("input");
          cb.addEventListener("change", () => {
            const itemsNow = loadActive();
            const actualIdx = idx - 1;
            const mission = itemsNow[actualIdx];
            itemsNow.splice(actualIdx, 1);
            saveActive(itemsNow);

            const completed = loadCompleted();
            completed.push({ ...mission, done: true });
            saveCompleted(completed);

            renderActive();
            renderCompleted();
          });

          const rm = el.querySelector("button");
          rm.addEventListener("click", () => {
            const itemsNow = loadActive();
            const actualIdx = idx - 1;
            itemsNow.splice(actualIdx, 1);
            saveActive(itemsNow);
            renderActive();
          });
        }

        container.appendChild(el);
      });
    }

    function renderCompleted() {
      const items = loadCompleted();
      const container = $("itemsCompleted");
      container.innerHTML = "";

      const withExample = [exampleCompleted, ...items];

      withExample.forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "item" + (it.isExample ? " example" : "");
        el.innerHTML = `
          <div class="itext">
            <div class="ititle">
              <span>${escapeHtml(it.title)}</span>
              <span class="itag">${escapeHtml(it.tag || "idea")}</span>
            </div>
            <p class="idesc">${escapeHtml(it.desc || "")}</p>
          </div>
          ${!it.isExample ? '<button class="btn" style="padding:8px 12px;" title="Undo">UNDO</button>' : ""}
        `;

        if (!it.isExample) {
          const undo = el.querySelector("button");
          undo.addEventListener("click", () => {
            const completedNow = loadCompleted();
            const actualIdx = idx - 1;
            const mission = completedNow[actualIdx];
            completedNow.splice(actualIdx, 1);
            saveCompleted(completedNow);

            const active = loadActive();
            active.push({ ...mission, done: false });
            saveActive(active);

            renderActive();
            renderCompleted();
          });
        }

        container.appendChild(el);
      });
    }

    function renderMessages() {
      const messages = loadMessages();
      const container = $("messageLog");
      container.innerHTML = "";

      messages.forEach(msg => {
        const displayName = msg.from || "Unknown";
        const el = document.createElement("div");
        el.className = "message-log-item";
        el.innerHTML = `
          <div class="message-log-header">
            <span>FROM: ${escapeHtml(displayName)}</span>
            <span>${escapeHtml(msg.timestamp || "")}</span>
          </div>
          <div class="message-log-content">${escapeHtml(msg.content || "")}</div>
        `;
        container.appendChild(el);
      });

      if (messages.length > 3) container.classList.add("scroll");
      else container.classList.remove("scroll");
    }

    function ensureCustomTagsInSelect() {
      const tags = loadCustomTags();
      const select = $("newTag");
      const existing = new Set(Array.from(select.options).map(o => o.value));

      tags.forEach(tag => {
        if (!existing.has(tag)) {
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = tag;
          select.insertBefore(opt, select.lastElementChild);
        }
      });
    }

    function openGift() {
      $("cover").classList.add("hidden");
      $("main").classList.remove("hidden");
      $("btnHome").classList.remove("hidden");
      renderActive();
      renderCompleted();
      renderMessages();
      updateNotifications();
    }

    function goHome() {
      $("cover").classList.remove("hidden");
      $("main").classList.add("hidden");
      $("btnHome").classList.add("hidden");
    }

    let snowTimer = null;

    function startSnow() {
      if (snowTimer) return;
      snowTimer = setInterval(() => {
        const s = document.createElement("div");
        s.className = "snowflake";
        s.textContent = Math.random() < 0.5 ? "❄" : "✦";
        s.style.left = Math.random() * 100 + "vw";
        s.style.animationDuration = (5 + Math.random() * 6) + "s";
        s.style.fontSize = (12 + Math.random() * 14) + "px";
        s.style.opacity = (0.35 + Math.random() * 0.6);
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 12000);
      }, 220);
    }

    function stopSnow() {
      if (snowTimer) {
        clearInterval(snowTimer);
        snowTimer = null;
      }
      document.querySelectorAll(".snowflake").forEach(s => s.remove());
    }

    function applyTheme(theme) {
      currentTheme = theme;

      if (theme === "dark") document.documentElement.setAttribute("data-theme", "dark");
      else if (theme === "light") document.documentElement.setAttribute("data-theme", "light");
      else if (theme === "christmas") document.documentElement.setAttribute("data-theme", "christmas");
      else document.documentElement.removeAttribute("data-theme");

      document.querySelectorAll(".theme-option").forEach(opt => {
        opt.classList.toggle("active", opt.dataset.theme === theme);
      });

      if (theme === "christmas") startSnow();
      else stopSnow();
    }

    function updateTracker() {
      const now = new Date();
      $("trackerNow").textContent = formatDT(now);

      const start2026 = new Date("2026-01-01T00:00:00");
      const end2026 = new Date("2027-01-01T00:00:00");

      if (now < start2026) {
        const diff = start2026.getTime() - now.getTime();
        const days = Math.floor(diff / (24*60*60*1000));
        $("trackerRemaining").textContent = `${days}d UNTIL 2026`;
        $("trackerElapsed").textContent = "NOT STARTED";
        $("trackerFill").style.width = "0%";
        return;
      }

      const elapsedMs = now.getTime() - start2026.getTime();
      const totalMs = end2026.getTime() - start2026.getTime();
      const pct = Math.max(0, Math.min(1, elapsedMs / totalMs));
      const daysElapsed = Math.floor(elapsedMs / (24*60*60*1000));
      const daysLeft = Math.max(0, Math.floor((end2026.getTime() - now.getTime()) / (24*60*60*1000)));

      $("trackerRemaining").textContent = `${daysLeft}d LEFT`;
      $("trackerElapsed").textContent = `${daysElapsed}d`;
      $("trackerFill").style.width = `${Math.round(pct * 1000) / 10}%`;
    }

    let suppressSync = false;
    let syncDebounce = null;

    function getLocalState() {
      return {
        active: loadActive(),
        saved: loadSaved(),
        completed: loadCompleted(),
        messages: loadMessages(),
        customTags: loadCustomTags(),
        systemMessage: loadSystemMessage(),
      };
    }

    function applyStateToLocal(state) {
      if (!state || typeof state !== "object") return;

      suppressSync = true;
      if (Array.isArray(state.active)) localStorage.setItem(KEY_ACTIVE, JSON.stringify(state.active));
      if (Array.isArray(state.saved)) localStorage.setItem(KEY_SAVED, JSON.stringify(state.saved));
      if (Array.isArray(state.completed)) localStorage.setItem(KEY_COMPLETED, JSON.stringify(state.completed));
      if (Array.isArray(state.messages)) localStorage.setItem(KEY_MESSAGES, JSON.stringify(state.messages));
      if (Array.isArray(state.customTags)) localStorage.setItem(KEY_CUSTOM_TAGS, JSON.stringify(state.customTags));
      if (typeof state.systemMessage === "string") localStorage.setItem(KEY_SYSTEM_MESSAGE, state.systemMessage);
      suppressSync = false;
    }

    async function remoteGetState() {
      const res = await fetch(`/.netlify/functions/room?room=${encodeURIComponent(ROOM_CODE)}`);
      if (!res.ok) throw new Error("Remote get failed");
      const data = await res.json();
      lastPresence = data?.presence || lastPresence;
      return data.payload || null;
    }

    async function remoteSetState(payload) {
      const res = await fetch(`/.netlify/functions/room`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ room: ROOM_CODE, payload })
      });
      if (!res.ok) throw new Error("Remote set failed");
      const data = await res.json();
      lastPresence = data?.presence || lastPresence;
      return true;
    }

    async function remotePatchPresence(userName) {
      const res = await fetch(`/.netlify/functions/room`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ room: ROOM_CODE, presence: { user: userName } })
      });
      if (!res.ok) throw new Error("Presence patch failed");
      const data = await res.json();
      return data;
    }

    async function pullRemoteState() {
      try {
        setSyncStatus("pulling");
        const remote = await remoteGetState();
        if (remote && Object.keys(remote).length) {
          applyStateToLocal(remote);
          ensureCustomTagsInSelect();
          renderSystemMessage(loadSystemMessage());
          renderActive();
          renderCompleted();
          renderMessages();
          updateNotifications();
        }
        setSyncStatus("on");
        updateUserDuoPills();
      } catch {
        setSyncStatus("error");
      }
    }

    async function pushRemoteState() {
      if (suppressSync) return;
      try {
        setSyncStatus("saving");
        await remoteSetState(getLocalState());
        setSyncStatus("on");
        updateUserDuoPills();
      } catch {
        setSyncStatus("error");
      }
    }

    function schedulePush() {
      if (suppressSync) return;
      clearTimeout(syncDebounce);
      syncDebounce = setTimeout(pushRemoteState, 600);
    }

    function openWhoModal() {
      $("whoModal").classList.add("active");
      $("whoModal").setAttribute("aria-hidden", "false");
      $("btnLogOff").classList.toggle("hidden", !hasUser());
    }

    function closeWhoModal() {
      $("whoModal").classList.remove("active");
      $("whoModal").setAttribute("aria-hidden", "true");
    }

    async function setUserAndStart(name) {
      saveUser(name);
      closeWhoModal();
      updateUserDuoPills();

      setSyncStatus("pulling");
      await pullRemoteState();
      startPresence();
      showToast(`USER SET: ${String(name).toUpperCase()}`);
    }

    function logOffUser() {
      localStorage.removeItem(KEY_USER);
      stopPresence();
      updateUserDuoPills();
      openWhoModal();
      showToast("LOGGED OFF");
    }

    $("btnOpen").addEventListener("click", openGift);
    $("btnHome").addEventListener("click", goHome);

    $("btnEditSystemMessage").addEventListener("click", async () => {
      const msg = prompt("Edit system message:", loadSystemMessage());
      if (msg !== null && msg.trim()) {
        const trimmed = msg.trim();
        showToast("Updating...");
        saveSystemMessageLocalOnly(trimmed);
        renderSystemMessage(trimmed);
        await pushRemoteState();
        showToast("Message updated");
      }
    });

    $("userPill").addEventListener("click", () => openWhoModal());

    $("btnWhoYasir").addEventListener("click", () => setUserAndStart("Yasir"));
    $("btnWhoKylee").addEventListener("click", () => setUserAndStart("Kylee"));
    $("closeWhoModal").addEventListener("click", () => closeWhoModal());
    $("btnLogOff").addEventListener("click", () => logOffUser());

    $("btnAdd").addEventListener("click", () => {
      if (!hasUser()) { showToast("Pick USER first"); return; }

      const title = $("newTitle").value.trim();
      const desc = $("newDesc").value.trim();
      const tagSelect = $("newTag");
      let tag = tagSelect.value;

      if (tag === "custom") {
        tag = $("customTagInput").value.trim() || "custom";
        const customTags = loadCustomTags();
        if (!customTags.includes(tag)) {
          customTags.push(tag);
          saveCustomTags(customTags);
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = tag;
          tagSelect.insertBefore(opt, tagSelect.lastElementChild);
        }
      }

      if (!title) return alert("Add a title first");

      const mission = { title, desc, tag, done: false };

      const active = loadActive();
      active.push(mission);
      saveActive(active);

      const saved = loadSaved();
      const isDuplicate = saved.some(s => s.title === mission.title && s.desc === mission.desc && s.tag === mission.tag);
      if (!isDuplicate) {
        saved.push(mission);
        saveSaved(saved);
      }

      $("newTitle").value = "";
      $("newDesc").value = "";
      $("newTag").value = "date";
      $("customTagInput").value = "";
      $("customTagField").classList.add("hidden");

      renderActive();
    });

    $("btnClearFields").addEventListener("click", () => {
      $("newTitle").value = "";
      $("newDesc").value = "";
      $("newTag").value = "date";
      $("customTagInput").value = "";
      $("customTagField").classList.add("hidden");
    });

    $("newTag").addEventListener("change", (e) => {
      if (e.target.value === "custom") $("customTagField").classList.remove("hidden");
      else $("customTagField").classList.add("hidden");
    });

    document.querySelectorAll(".mission-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".mission-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        if (tab.dataset.tab === "active") {
          $("activeTab").classList.remove("hidden");
          $("completedTab").classList.add("hidden");
        } else {
          $("activeTab").classList.add("hidden");
          $("completedTab").classList.remove("hidden");
        }
      });
    });

    $("btnAddSaved").addEventListener("click", () => {
      const saved = loadSaved();
      const container = $("savedMissionsList");
      container.innerHTML = "";
      selectedSavedMissions = [];

      if (saved.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); text-align: center;">No saved missions yet. Add one first!</p>';
      } else {
        saved.forEach((mission, idx) => {
          const card = document.createElement("div");
          card.className = "saved-mission-card";
          card.dataset.idx = idx;
          card.innerHTML = `
            <div class="saved-mission-header">
              <div class="itext">
                <div class="ititle">
                  <span>${escapeHtml(mission.title)}</span>
                  <span class="itag">${escapeHtml(mission.tag)}</span>
                </div>
                <p class="idesc">${escapeHtml(mission.desc || "")}</p>
              </div>
              <div class="saved-mission-actions">
                <button class="btn" data-action="select">SELECT</button>
                <button class="btn" data-action="edit">EDIT & ADD</button>
              </div>
            </div>
          `;

          card.querySelector('[data-action="select"]').addEventListener("click", () => {
            if (selectedSavedMissions.includes(idx)) {
              selectedSavedMissions = selectedSavedMissions.filter(i => i !== idx);
              card.classList.remove("selected");
            } else {
              selectedSavedMissions.push(idx);
              card.classList.add("selected");
            }
          });

          card.querySelector('[data-action="edit"]').addEventListener("click", () => {
            $("newTitle").value = mission.title;
            $("newDesc").value = mission.desc;

            const tagSelect = $("newTag");
            const hasTag = Array.from(tagSelect.options).some(opt => opt.value === mission.tag);
            if (hasTag) {
              tagSelect.value = mission.tag;
            } else {
              tagSelect.value = "custom";
              $("customTagField").classList.remove("hidden");
              $("customTagInput").value = mission.tag;
            }

            $("savedMissionsModal").classList.remove("active");
            alert("Mission loaded for editing. Click 'Add Mission' to add the edited version to Active list.");
          });

          container.appendChild(card);
        });
      }

      $("savedMissionsModal").classList.add("active");
    });

    $("btnAddSelectedMissions").addEventListener("click", () => {
      if (selectedSavedMissions.length === 0) return alert("Please select at least one mission");

      const saved = loadSaved();
      const active = loadActive();

      selectedSavedMissions.forEach(idx => {
        const mission = saved[idx];
        active.push({ ...mission, done: false });
      });

      saveActive(active);
      renderActive();
      $("savedMissionsModal").classList.remove("active");
      selectedSavedMissions = [];
    });

    $("closeSavedModal").addEventListener("click", () => {
      $("savedMissionsModal").classList.remove("active");
    });

    $("btnSaveNote").addEventListener("click", () => {
      if (!hasUser()) { showToast("Pick USER first"); return; }

      const content = $("customNote").value.trim();
      if (!content) return alert("Write a message first");

      const from = loadUser().trim();
      const timestamp = new Date().toLocaleString();
      const messages = loadMessages();
      messages.push({ from, timestamp, content });
      saveMessages(messages);

      $("customNote").value = "";
      renderMessages();
      updateNotifications();
      showToast("Letter sent");
    });

    $("envelopeBtn").addEventListener("click", () => {
      if (!hasUser()) { showToast("Pick USER first"); return; }

      const messages = loadMessages();
      const userLower = loadUser().trim().toLowerCase();

      let idx = -1;
      for (let i = messages.length - 1; i >= 0; i--) {
        const fromLower = String(messages[i]?.from || "").trim().toLowerCase();
        if (fromLower && fromLower !== userLower) { idx = i; break; }
      }

      if (idx >= 0) openMessage(idx);
      else alert("No letters from your DUO yet!");
    });

    $("notificationBell").addEventListener("click", () => {
      $("notificationDropdown").classList.toggle("active");
    });

    $("btnNotifClearAll").addEventListener("click", (e) => {
      e.stopPropagation();
      clearAllNotifications();
    });

    $("closeLetterModal").addEventListener("click", () => {
      $("letterModal").classList.remove("active");
    });

    $("btnDownloadText").addEventListener("click", () => {
      const active = loadActive();
      const completed = loadCompleted().filter(c => !c.isExample);

      const text = `kywee + yessir bucket list - 2026
====================

SYSTEM MESSAGE:
${loadSystemMessage()}

ACTIVE MISSIONS:
${active.map(i => `[ ] ${i.title} — ${i.desc} (#${i.tag})`).join("\n")}

COMPLETED MISSIONS:
${completed.map(i => `[X] ${i.title} — ${i.desc} (#${i.tag})`).join("\n")}
`;

      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kywee-yessir-bucket-list-2026.txt";
      a.click();
      URL.revokeObjectURL(url);
    });

    $("themeBtn").addEventListener("click", () => {
      $("themeDropdown").classList.toggle("active");
    });

    document.querySelectorAll(".theme-option").forEach(option => {
      option.addEventListener("click", () => {
        const theme = option.dataset.theme;
        saveTheme(theme);
        applyTheme(theme);
        $("themeDropdown").classList.remove("active");
      });
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".theme-switcher")) $("themeDropdown").classList.remove("active");
      if (!e.target.closest("#notificationBell") && !e.target.closest("#notificationDropdown")) {
        $("notificationDropdown").classList.remove("active");
      }
    });

    window.addEventListener("focus", () => {
      pullRemoteState();
    });

    (function init() {
      ensureCustomTagsInSelect();

      const theme = loadTheme();
      applyTheme(theme);

      renderSystemMessage(loadSystemMessage());

      setSyncStatus("off");
      updateUserDuoPills();
      updateNotifications();
      updateTracker();
      setInterval(updateTracker, 1000);

      pullRemoteState();

      if (!hasUser()) openWhoModal();
      else startPresence();
    })();
  </script>
</body>
</html>
