<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>kywee + yessir bucket list</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');

    :root {
      --bg: #0a0a0a;
      --bg-card: #141414;
      --text: #ffffff;
      --muted: #999999;
      --accent: #ff6b9d;
      --accent-dim: #d4587e;
      --accent-secondary: #7b68ee;
      --border: #333333;
      --border-bright: #555555;
      --shadow: 0 0 40px rgba(255,107,157,.15);
    }

    [data-theme="light"] {
      --bg: #f5f5f5;
      --bg-card: #ffffff;
      --text: #1a1a1a;
      --muted: #666666;
      --accent: #e91e63;
      --accent-dim: #c2185b;
      --accent-secondary: #673ab7;
      --border: #e0e0e0;
      --border-bright: #bdbdbd;
      --shadow: 0 2px 15px rgba(0,0,0,.1);
    }

    [data-theme="dark"] {
      --bg: #000000;
      --bg-card: #0a0a0a;
      --text: #ffffff;
      --muted: #999999;
      --accent: #d4ff00;
      --accent-dim: #8fb300;
      --accent-secondary: #d4ff00;
      --border: #333333;
      --border-bright: #d4ff00;
      --shadow: 0 0 40px rgba(212,255,0,.15);
    }

    [data-theme="christmas"] {
      --bg: #0f1e14;
      --bg-card: #1a2e1f;
      --text: #ffffff;
      --muted: #a8b5ac;
      --accent: #e74c3c;
      --accent-dim: #c0392b;
      --accent-secondary: #27ae60;
      --border: #2d4a35;
      --border-bright: #4a7c59;
      --shadow: 0 4px 20px rgba(231,76,60,.2);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Roboto Mono', monospace;
      color: var(--text);
      min-height: 100vh;
      background: var(--bg);
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1),
        rgba(0, 0, 0, 0.1) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    [data-theme="dark"] body::before,
    [data-theme="christmas"] body::before {
      opacity: 0.15;
    }

    a { color: inherit; }

    .wrap {
      width: min(1100px, 94vw);
      margin: 0 auto;
      padding: 20px 0 80px;
      position: relative;
      z-index: 10; /* keeps snow behind UI */
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 16px 20px;
      border: 2px solid var(--border-bright);
      background: var(--bg);
      box-shadow: var(--shadow);
      position: sticky;
      top: 14px;
      z-index: 50;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: 1.5px;
      font-size: 13px;
    }

    .topbar-right {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 11px;
      padding: 6px 12px;
      border: 1px solid var(--border-bright);
      color: var(--accent);
      background: var(--bg);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      user-select: none;
    }

    .btn {
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--text);
      padding: 10px 16px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 1px;
      font-family: 'Roboto Mono', monospace;
    }

    .btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 20px rgba(255,107,157,.3);
    }

    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }

    .btn.primary:hover {
      background: var(--accent-dim);
      border-color: var(--accent-dim);
    }

    .theme-switcher {
      position: relative;
      display: inline-block;
    }

    .theme-btn {
      padding: 8px 12px;
      font-size: 11px;
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-bright);
      box-shadow: var(--shadow);
      min-width: 180px;
      z-index: 100;
      display: none;
    }

    .theme-dropdown.active { display: block; }

    .theme-option {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.15s ease;
    }

    .theme-option:last-child { border-bottom: none; }
    .theme-option:hover { background: var(--accent); color: #000; }
    .theme-option.active { background: rgba(255,107,157,.1); color: var(--accent); font-weight: 700; }

    .notification-bell {
      position: relative;
      cursor: pointer;
      transition: all 0.15s ease;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .notification-bell svg {
      width: 20px;
      height: 20px;
      fill: var(--text);
      transition: fill 0.15s ease;
    }

    .notification-bell:hover svg { fill: var(--accent); }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: #000;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
    }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-bright);
      box-shadow: var(--shadow);
      min-width: 280px;
      max-width: 320px;
      z-index: 100;
      display: none;
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-dropdown.active { display: block; }

    .notification-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      color: var(--accent);
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .notification-item:last-child { border-bottom: none; }
    .notification-item:hover { background: rgba(255,107,157,.05); }
    .notification-item.unread { background: rgba(255,107,157,.08); border-left: 3px solid var(--accent); }

    .notification-from { font-size: 10px; color: var(--accent); font-weight: 700; margin-bottom: 4px; }
    .notification-preview { font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .notification-time { font-size: 9px; color: var(--muted); margin-top: 4px; }

    .cover {
      margin-top: 26px;
      border: 2px solid var(--border-bright);
      background: var(--bg-card);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .cover::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
      z-index: 20;
    }

    /* ✅ MORE PRONOUNCED CHRISTMAS LIGHTS */
    .christmas-lights {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 72px;
      display: none;
      align-items: flex-start;
      justify-content: space-evenly;
      padding: 10px 18px 0;
      pointer-events: none;
      z-index: 80; /* foreground */
      filter: saturate(1.35) contrast(1.15);
    }

    [data-theme="christmas"] .christmas-lights { display: flex; }

    .christmas-lights::before {
      content: "";
      position: absolute;
      left: -24px;
      right: -24px;
      top: 28px;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border-top: 1px solid rgba(255,255,255,0.22);
      box-shadow: 0 0 18px rgba(255,255,255,0.12);
    }

    .light {
      position: relative;
      width: 14px;
      height: 22px;
      border-radius: 10px 10px 12px 12px;
      transform: translateY(24px);
      box-shadow: 0 0 22px currentColor, 0 0 70px currentColor;
      opacity: 0.98;
      animation: twinkle 1.8s infinite ease-in-out;
    }

    .light::before {
      content: "";
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 6px;
      border-radius: 3px 3px 0 0;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.15);
      border-bottom: none;
    }

    .light::after {
      content: "";
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 1px;
      height: 20px;
      background: rgba(255,255,255,0.18);
    }

    .light:nth-child(1) { color: #ff3b3b; animation-delay: 0s; }
    .light:nth-child(2) { color: #3bff6b; animation-delay: 0.15s; }
    .light:nth-child(3) { color: #3b7bff; animation-delay: 0.3s; }
    .light:nth-child(4) { color: #ffe93b; animation-delay: 0.45s; }
    .light:nth-child(5) { color: #ff3bf7; animation-delay: 0.6s; }
    .light:nth-child(6) { color: #3bfff0; animation-delay: 0.75s; }
    .light:nth-child(7) { color: #ff8a3b; animation-delay: 0.9s; }
    .light:nth-child(8) { color: #b83bff; animation-delay: 1.05s; }

    @keyframes twinkle {
      0%, 100% { filter: brightness(1); transform: translateY(24px) scale(1); opacity: 0.96; }
      50% { filter: brightness(1.55); transform: translateY(24px) scale(1.08); opacity: 1; }
    }

    .coverInner {
      padding: 60px 30px 40px;
      text-align: center;
      border: 1px solid var(--border);
      margin: 10px;
      position: relative;
      z-index: 30;
    }

    .big {
      font-size: clamp(32px, 5vw, 52px);
      margin: 0 0 20px;
      line-height: 1;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .sub {
      color: var(--muted);
      font-size: 14px;
      max-width: 70ch;
      margin: 0 auto 24px;
      line-height: 1.6;
    }

    .emoticon-art {
      color: var(--accent);
      font-size: 10px;
      line-height: 1.2;
      margin: 20px auto;
      display: inline-block;
      font-family: monospace;
    }

    .heart {
      width: 60px;
      height: 60px;
      margin: 0 auto 24px;
      filter: drop-shadow(0 0 15px var(--accent));
      transition: filter 0.3s ease;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .topbar { position: static; }
    }

    .card {
      border: 2px solid var(--border);
      background: var(--bg-card);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--accent);
    }

    .cardHeader {
      padding: 18px 20px;
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: rgba(255,107,157,.03);
      transition: all 0.3s ease;
    }

    .cardHeader h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      font-weight: 700;
    }

    .cardBody { padding: 20px; }

    .note {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      border-left: 2px solid var(--accent);
      padding-left: 12px;
    }

    .mission-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .mission-tab {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
      margin-bottom: -2px;
    }

    .mission-tab:hover { color: var(--accent); }
    .mission-tab.active { border-bottom-color: var(--accent); color: var(--accent); }

    .items {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .item {
      border: 1px solid var(--border);
      padding: 14px;
      background: var(--bg);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: all 0.15s ease;
      position: relative;
    }

    .item.example { opacity: 0.5; border-style: dashed; }

    .item::before {
      content: "";
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 2px;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .item:hover { border-color: var(--accent); box-shadow: 0 0 20px rgba(255,107,157,.2); }
    .item:hover::before { opacity: 1; }

    .item input[type="checkbox"] {
      margin-top: 3px;
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .itext { flex: 1; }

    .ititle {
      margin: 0;
      font-weight: 700;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .itag {
      font-size: 10px;
      padding: 4px 8px;
      border: 1px solid var(--accent);
      color: var(--accent);
      background: rgba(255,107,157,.05);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .idesc {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .form {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 11px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--text);
      outline: none;
      font-family: 'Roboto Mono', monospace;
      font-size: 13px;
      transition: all 0.15s ease;
    }

    select { cursor: pointer; }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(255,107,157,.2);
    }

    textarea { min-height: 90px; resize: vertical; }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    hr { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

    .footer {
      margin-top: 24px;
      text-align: center;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hidden { display: none !important; }

    .cursor {
      display: inline-block;
      width: 10px;
      height: 1em;
      background: var(--accent);
      margin-left: 5px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0; }
    }

    .corner-decor { position: absolute; width: 20px; height: 20px; border: 2px solid var(--accent); z-index: 60; }
    .corner-decor.tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
    .corner-decor.tr { top: 10px; right: 10px; border-left: none; border-bottom: none; }
    .corner-decor.bl { bottom: 10px; left: 10px; border-right: none; border-top: none; }
    .corner-decor.br { bottom: 10px; right: 10px; border-left: none; border-top: none; }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: var(--bg-card);
      border: 2px solid var(--border-bright);
      box-shadow: var(--shadow);
      max-width: 800px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 30px;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
    }

    .modal-close {
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      transition: color 0.15s ease;
    }

    .modal-close:hover { color: var(--accent); }

    .saved-mission-card {
      border: 1px solid var(--border);
      padding: 14px;
      margin-bottom: 12px;
      background: var(--bg);
      position: relative;
    }

    .saved-mission-card.selected {
      border-color: var(--accent);
      background: rgba(255,107,157,.05);
    }

    .saved-mission-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .saved-mission-actions { display: flex; gap: 8px; }

    .envelope-container {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      transition: all 0.15s ease;
      user-select: none;
    }

    .envelope-container:hover { border-color: var(--accent); color: var(--accent); }

    /* makes just the name clickable without breaking open-last-letter */
    #fromPill { cursor: pointer; text-decoration: underline; text-underline-offset: 3px; }

    .letter-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .letter-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .letter-envelope {
      width: 400px;
      max-width: 90vw;
      background: #c9b17a;
      border: 3px solid #8b7355;
      padding: 40px;
      position: relative;
      transform-origin: center;
      animation: envelopeOpen 0.5s ease forwards;
    }

    @keyframes envelopeOpen {
      from { transform: scale(0.8) rotateX(-10deg); opacity: 0; }
      to { transform: scale(1) rotateX(0deg); opacity: 1; }
    }

    .letter-paper {
      background: #f4ecd8;
      border: 2px solid #8b7355;
      padding: 30px;
      font-family: 'Roboto Mono', monospace;
      color: #2c2416;
      line-height: 1.6;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform-origin: top;
      animation: letterUnfold 0.5s ease 0.3s forwards;
      opacity: 0;
    }

    @keyframes letterUnfold {
      from { transform: scaleY(0); opacity: 0; }
      to { transform: scaleY(1); opacity: 1; }
    }

    .letter-from {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #666;
    }

    .letter-timestamp { font-size: 10px; color: #999; margin-bottom: 16px; }

    .letter-content {
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .letter-close {
      position: absolute;
      top: 10px; right: 10px;
      width: 30px; height: 30px;
      background: var(--bg);
      border: 2px solid var(--accent);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.15s ease;
    }

    .letter-close:hover { background: var(--accent); color: #000; }

    #messageLog {
      max-height: 300px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .message-log-item {
      border: 1px solid var(--border);
      padding: 12px;
      margin-bottom: 12px;
      background: var(--bg);
    }

    .message-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 10px;
      color: var(--muted);
    }

    .message-log-content {
      font-size: 12px;
      line-height: 1.5;
      color: var(--text);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      box-shadow: var(--shadow);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      z-index: 3000;
      animation: slideInToast 0.3s ease, slideOutToast 0.3s ease 2.7s;
      pointer-events: none;
    }

    @keyframes slideInToast {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutToast {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }

    /* ✅ Snow is visible but behind content */
    .snowflake {
      position: fixed;
      top: -10px;
      font-size: 14px;
      opacity: 0.85;
      pointer-events: none;
      animation: fall linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
      z-index: 5;
    }

    @keyframes fall {
      to { transform: translateY(110vh) rotate(360deg); opacity: 0.25; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span>[▸] 2026 BUCKET_LIST.EXE</span>
      </div>

      <div class="topbar-right">
        <button class="btn hidden" id="btnHome">◂ HOME</button>

        <div style="position: relative;">
          <div class="notification-bell" id="notificationBell" aria-label="Notifications" title="Notifications">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
            </svg>
            <span class="notification-badge hidden" id="notificationBadge">0</span>
          </div>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">MESSAGES</div>
            <div id="notificationList"></div>
          </div>
        </div>

        <button class="btn" id="btnPair">PAIR</button>
        <span class="pill" id="syncPill">SYNC: OFF</span>

        <button class="btn" id="btnDownloadText">EXPORT .TXT</button>

        <div class="theme-switcher">
          <button class="btn theme-btn" id="themeBtn">THEME</button>
          <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option active" data-theme="system">System</div>
            <div class="theme-option" data-theme="light">Light</div>
            <div class="theme-option" data-theme="dark">Dark</div>
            <div class="theme-option" data-theme="christmas">Christmas</div>
          </div>
        </div>
      </div>
    </div>

    <section class="cover" id="cover">
      <div class="christmas-lights">
        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
      </div>

      <div class="corner-decor tl"></div>
      <div class="corner-decor tr"></div>
      <div class="corner-decor bl"></div>
      <div class="corner-decor br"></div>

      <div class="coverInner">
        <svg class="heart" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 21s-7.2-4.6-9.7-8.9C.5 8.9 2.1 5.8 5.5 5.1c1.7-.3 3.4.3 4.5 1.6 1.1-1.3 2.8-1.9 4.5-1.6 3.4.7 5 3.8 3.2 7-2.5 4.3-9.7 8.9-9.7 8.9Z"
                fill="currentColor" stroke="currentColor" stroke-width="0.5" style="color: var(--accent);"/>
        </svg>

        <h1 class="big">SYSTEM MESSAGE:<br><span id="herName">MY LOVE</span><span class="cursor"></span></h1>

        <p class="sub">[INITIALIZING...] Our bucket list for the new year. Status: READY TO DEPLOY.</p>

        <pre class="emoticon-art">⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⠟⠿⣷⣦⡀⠀⠀⠀⠀⠀⠀⣀⣴⣿⠿⣷⣦⡀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣰⣿⠟⠀⠀⠀⠈⠻⣿⣦⣤⣤⣤⣤⣾⡿⠋⠁⠀⠈⠻⣿⣦⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢰⣿⠏⠀⠀⠀⠀⠀⠀⢸⠙⠉⢹⢉⢹⠉⠁⠀⠀⠀⠀⠀⠈⣿⡇⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣤⣤⣬⣷⣶⣶⣴⣶⣶⣶⣤⠀⣧⠀⣼⠘⢺⣤⣤⣴⣶⣶⣶⣶⣤⣭⣤⡀⠀⠀⠀⠀
⠀⠿⣷⣶⢽⣿⠉⠁⠀⠈⠉⠉⠉⠸⣿⠀⠀⠀⢀⣀⣸⣿⠉⠉⠉⠉⠉⠉⠉⠉⣿⣇⣴⣾⠿⠀
⣠⣴⣶⡦⢸⣿⠀⢀⣀⠀⠀⠀⠀⠀⣿⡿⠿⠿⠿⠟⢻⣿⠀⠀⠀⠀⢀⣀⠀⠀⣿⣿⣿⣥⣤⡀
⠈⠉⠁⠀⢸⣿⣀⣼⣿⣃⣤⣤⣤⣴⣿⡅⠀⠀⠀⠀⠸⣿⣦⣤⣤⣀⣸⣿⣀⣸⣿⠋⠉⠉⠛⠋
⠀⠀⠀⠀⣘⣟⡿⡋⠑⢽⠛⠉⠉⠉⠻⢿⣿⣿⡿⢿⣿⠏⠉⠉⠙⠛⠛⠛⠛⣻⣯⠀⠀⠀⠀⠀
⠀⢀⡖⠉⠉⠀⠠⠇⠀⠸⣶⣶⣶⣤⠀⢸⣿⣿⣷⣿⡏⠀⠀⠀⠀⢀⣀⣴⣾⡿⠋⠀⠀⠀⠀⠀
⠀⠘⢷⡀⠁⠀⠀⠀⠀⠀⢹⠀⠈⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⠛⢉⣿⡿⠀⠀⠀⠀⠀⠀
⠀⠀⠈⠱⣤⣀⠀⠀⢀⣠⡞⠀⠀⠀⠀⠀⠀⠀⠤⠀⠀⠀⠀⠀⠀⠀⣾⡿⠟⠁⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠈⠓⠒⠚⠁⣿⣇⢀⣀⣀⣀⣀⣀⣀⣐⣀⣀⣀⣤⣤⣄⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣿⣿⠟⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠉⠻⠿⠿⠃⠀⠀⠀⠀⠀⠀⠀⠀</pre>

        <div class="actions" style="justify-content:center; margin-top:30px;">
          <button class="btn primary" id="btnOpen">▸ INITIALIZE SYSTEM</button>
          <button class="btn" id="btnEditSystemMessage">EDIT SYSTEM MESSAGE</button>
        </div>
      </div>
    </section>

    <section class="grid hidden" id="main">
      <div class="card">
        <div class="cardHeader">
          <h2>[▸] MISSION_LIST.LOG</h2>
          <span class="pill" id="yearPill">2026</span>
        </div>
        <div class="cardBody">
          <div class="mission-tabs">
            <div class="mission-tab active" data-tab="active">Active Missions</div>
            <div class="mission-tab" data-tab="completed">Completed Missions</div>
          </div>

          <div id="activeTab">
            <div class="note">// STATUS: Items are auto-saved. Check to mark complete.</div>
            <div class="items" id="itemsActive"></div>
            <div class="actions">
              <button class="btn primary" id="btnAddSaved">ADD SAVED MISSION</button>
            </div>
          </div>

          <div id="completedTab" class="hidden">
            <div class="note">// COMPLETED: Missions you've finished.</div>
            <div class="items" id="itemsCompleted"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h2>[▸] MESSAGE_LOG</h2>
          <div class="envelope-container" id="envelopeBtn" title="Open latest letter">
            <span aria-hidden="true">✉</span>
            <span id="fromPill">FROM: YASIR</span>
          </div>
        </div>

        <div class="cardBody">
          <p class="note" id="loveNote">// SYSTEM MESSAGE: MY LOVE</p>

          <div id="messageLog"></div>

          <div class="form">
            <div class="field">
              <label for="customNote">[▸] NEW MESSAGE</label>
              <textarea id="customNote" placeholder="// Enter your message here..."></textarea>
            </div>
            <button class="btn primary" id="btnSaveNote">SEND LETTER</button>
          </div>

          <hr />

          <div class="field">
            <label>[▸] ADD NEW MISSION</label>
            <input id="newTitle" type="text" placeholder="Movie">
          </div>
          <div class="field">
            <input id="newDesc" type="text" placeholder="pick a movie and location">
          </div>
          <div class="field">
            <label for="newTag">TAG</label>
            <select id="newTag">
              <option value="date">date</option>
              <option value="travel">travel</option>
              <option value="cozy">cozy</option>
              <option value="food">food</option>
              <option value="home">home</option>
              <option value="romantic">romantic</option>
              <option value="fun">fun</option>
              <option value="tradition">tradition</option>
              <option value="music">music</option>
              <option value="new">new</option>
              <option value="heart">heart</option>
              <option value="custom">Custom...</option>
            </select>
          </div>
          <div class="field hidden" id="customTagField">
            <input id="customTagInput" type="text" placeholder="Enter custom tag">
          </div>
          <div class="actions">
            <button class="btn primary" id="btnAdd">+ ADD MISSION</button>
            <button class="btn" id="btnClearFields">CLEAR FIELDS</button>
          </div>

          <div class="footer">[ COMPILED FOR ONE SPECIAL KITTEN ]</div>
        </div>
      </div>
    </section>
  </div>

  <div class="modal" id="savedMissionsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Saved Missions Database</h3>
        <span class="modal-close" id="closeSavedModal">✖</span>
      </div>
      <div id="savedMissionsList"></div>
      <div class="actions">
        <button class="btn primary" id="btnAddSelectedMissions">ADD SELECTED TO ACTIVE</button>
      </div>
    </div>
  </div>

  <div class="letter-modal" id="letterModal">
    <div class="letter-envelope">
      <div class="letter-close" id="closeLetterModal">✖</div>
      <div class="letter-paper">
        <div class="letter-from">FROM: <span id="letterFrom">YASIR</span></div>
        <div class="letter-timestamp" id="letterTimestamp"></div>
        <div class="letter-content" id="letterContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Local keys ----------
    const KEY_ACTIVE = "bucketlist_2026_active";
    const KEY_SAVED = "bucketlist_2026_saved";
    const KEY_COMPLETED = "bucketlist_2026_completed";
    const KEY_MESSAGES = "bucketlist_2026_messages";
    const KEY_CUSTOM_TAGS = "bucketlist_2026_custom_tags";
    const KEY_THEME = "bucketlist_2026_theme";
    const KEY_SYSTEM_MESSAGE = "bucketlist_2026_system_message";

    // identity + pairing (shared sync)
    const KEY_IDENTITY = "bucketlist_2026_identity";
    const KEY_ROOM = "bucketlist_2026_room";
    const KEY_ROOM_SECRET = "bucketlist_2026_room_secret";

    const $ = (id) => document.getElementById(id);

    const exampleActive = { title: "Test Mission (Example)", desc: "This is an example card", tag: "example", done: false, isExample: true };
    const exampleCompleted = { title: "Test Completed (Example)", desc: "This is a completed example", tag: "example", done: true, isExample: true };

    let selectedSavedMissions = [];
    let currentTheme = "system";

    // ---------- helpers ----------
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ---------- identity ----------
    function loadIdentity() { return localStorage.getItem(KEY_IDENTITY) || "Yasir"; }
    function saveIdentity(name) { localStorage.setItem(KEY_IDENTITY, name); }
    function renderFromPill() {
      $("fromPill").textContent = `FROM: ${loadIdentity().toUpperCase()}`;
    }

    function setIdentityPrompt() {
      const cur = loadIdentity();
      const next = prompt("Who is sending right now? (Yasir or Kylee)", cur);
      if (next === null) return;
      const cleaned = next.trim();
      if (!cleaned) return;
      saveIdentity(cleaned);
      renderFromPill();
      showToast("Sender updated");
    }

    // ---------- local storage state ----------
    function loadArray(key) {
      try {
        const saved = JSON.parse(localStorage.getItem(key));
        return Array.isArray(saved) ? saved : [];
      } catch { return []; }
    }

    function saveArray(key, arr) {
      localStorage.setItem(key, JSON.stringify(arr));
      schedulePush(); // if paired, push to shared
    }

    function loadActive() { return loadArray(KEY_ACTIVE); }
    function saveActive(items) { saveArray(KEY_ACTIVE, items); }

    function loadSaved() { return loadArray(KEY_SAVED); }
    function saveSaved(items) { saveArray(KEY_SAVED, items); }

    function loadCompleted() { return loadArray(KEY_COMPLETED); }
    function saveCompleted(items) { saveArray(KEY_COMPLETED, items); }

    function loadMessages() { return loadArray(KEY_MESSAGES); }
    function saveMessages(msgs) { saveArray(KEY_MESSAGES, msgs); }

    function loadCustomTags() { return loadArray(KEY_CUSTOM_TAGS); }
    function saveCustomTags(tags) { saveArray(KEY_CUSTOM_TAGS, tags); }

    function loadTheme() { return localStorage.getItem(KEY_THEME) || "system"; }
    function saveTheme(theme) { localStorage.setItem(KEY_THEME, theme); }

    function loadSystemMessage() { return localStorage.getItem(KEY_SYSTEM_MESSAGE) || "My Love"; }
    function saveSystemMessage(msg) {
      localStorage.setItem(KEY_SYSTEM_MESSAGE, msg);
      schedulePush(); // shared
    }

    function renderSystemMessage(msg) {
      $("herName").textContent = String(msg).toUpperCase();
      $("loveNote").textContent = `// SYSTEM MESSAGE: ${String(msg).toUpperCase()}`;
    }

    // ---------- Notifications ----------
    function updateNotifications() {
      const messages = loadMessages();
      const unread = messages.filter(m => m.read === false);

      const badge = $("notificationBadge");
      const list = $("notificationList");

      if (unread.length > 0) {
        badge.textContent = unread.length;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }

      list.innerHTML = "";
      if (messages.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted); font-size: 11px;">No messages yet</div>';
        return;
      }

      messages.slice().reverse().forEach((msg, idx) => {
        const displayName = msg.from || "Unknown";
        const item = document.createElement("div");
        item.className = "notification-item" + (msg.read === false ? " unread" : "");
        item.innerHTML = `
          <div class="notification-from">FROM: ${escapeHtml(displayName)}</div>
          <div class="notification-preview">${escapeHtml(msg.content.substring(0, 50))}${msg.content.length > 50 ? "..." : ""}</div>
          <div class="notification-time">${escapeHtml(msg.timestamp)}</div>
        `;
        item.addEventListener("click", () => {
          openMessage(messages.length - 1 - idx);
          $("notificationDropdown").classList.remove("active");
        });
        list.appendChild(item);
      });
    }

    function openMessage(index) {
      const messages = loadMessages();
      const msg = messages[index];
      if (!msg) return;

      const displayName = msg.from || "Unknown";
      $("letterFrom").textContent = displayName.toUpperCase();
      $("letterTimestamp").textContent = msg.timestamp;
      $("letterContent").textContent = msg.content;

      if (msg.read === false) {
        messages[index].read = true;
        saveMessages(messages);
        showToast("Letter read");
        updateNotifications();
      }

      $("letterModal").classList.add("active");
    }

    // ---------- UI render ----------
    function renderActive() {
      const items = loadActive();
      const container = $("itemsActive");
      container.innerHTML = "";

      const withExample = [exampleActive, ...items];

      withExample.forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "item" + (it.isExample ? " example" : "");
        el.innerHTML = `
          <input type="checkbox" ${it.done ? "checked" : ""} ${it.isExample ? "disabled" : ""} aria-label="Mark done">
          <div class="itext">
            <div class="ititle">
              <span>${escapeHtml(it.title)}</span>
              <span class="itag">${escapeHtml(it.tag || "idea")}</span>
            </div>
            <p class="idesc">${escapeHtml(it.desc || "")}</p>
          </div>
          ${!it.isExample ? '<button class="btn" style="padding:8px 12px;" title="Remove">[X]</button>' : ""}
        `;

        if (!it.isExample) {
          const cb = el.querySelector("input");
          cb.addEventListener("change", () => {
            const itemsNow = loadActive();
            const actualIdx = idx - 1;
            const mission = itemsNow[actualIdx];
            itemsNow.splice(actualIdx, 1);
            saveActive(itemsNow);

            const completed = loadCompleted();
            completed.push({ ...mission, done: true });
            saveCompleted(completed);

            renderActive();
            renderCompleted();
          });

          const rm = el.querySelector("button");
          rm.addEventListener("click", () => {
            const itemsNow = loadActive();
            const actualIdx = idx - 1;
            itemsNow.splice(actualIdx, 1);
            saveActive(itemsNow);
            renderActive();
          });
        }

        container.appendChild(el);
      });
    }

    function renderCompleted() {
      const items = loadCompleted();
      const container = $("itemsCompleted");
      container.innerHTML = "";

      const withExample = [exampleCompleted, ...items];

      withExample.forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "item" + (it.isExample ? " example" : "");
        el.innerHTML = `
          <div class="itext">
            <div class="ititle">
              <span>${escapeHtml(it.title)}</span>
              <span class="itag">${escapeHtml(it.tag || "idea")}</span>
            </div>
            <p class="idesc">${escapeHtml(it.desc || "")}</p>
          </div>
          ${!it.isExample ? '<button class="btn" style="padding:8px 12px;" title="Undo">UNDO</button>' : ""}
        `;

        if (!it.isExample) {
          const undo = el.querySelector("button");
          undo.addEventListener("click", () => {
            const completedNow = loadCompleted();
            const actualIdx = idx - 1;
            const mission = completedNow[actualIdx];
            completedNow.splice(actualIdx, 1);
            saveCompleted(completedNow);

            const active = loadActive();
            active.push({ ...mission, done: false });
            saveActive(active);

            renderActive();
            renderCompleted();
          });
        }

        container.appendChild(el);
      });
    }

    function renderMessages() {
      const messages = loadMessages();
      const container = $("messageLog");
      container.innerHTML = "";

      messages.forEach(msg => {
        const displayName = msg.from || "Unknown";
        const el = document.createElement("div");
        el.className = "message-log-item";
        el.innerHTML = `
          <div class="message-log-header">
            <span>FROM: ${escapeHtml(displayName)}</span>
            <span>${escapeHtml(msg.timestamp)}</span>
          </div>
          <div class="message-log-content">${escapeHtml(msg.content)}</div>
        `;
        container.appendChild(el);
      });
    }

    function ensureCustomTagsInSelect() {
      const tags = loadCustomTags();
      const select = $("newTag");
      const existing = new Set(Array.from(select.options).map(o => o.value));

      tags.forEach(tag => {
        if (!existing.has(tag)) {
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = tag;
          select.insertBefore(opt, select.lastElementChild);
        }
      });
    }

    // ---------- cover/main toggle ----------
    function openGift() {
      $("cover").classList.add("hidden");
      $("main").classList.remove("hidden");
      $("btnHome").classList.remove("hidden");
      renderActive();
      renderCompleted();
      renderMessages();
      updateNotifications();
    }

    function goHome() {
      $("cover").classList.remove("hidden");
      $("main").classList.add("hidden");
      $("btnHome").classList.add("hidden");
    }

    // ---------- Theme + Snow (christmas only) ----------
    let snowTimer = null;

    function startSnow() {
      if (snowTimer) return;
      snowTimer = setInterval(() => {
        const s = document.createElement("div");
        s.className = "snowflake";
        s.textContent = Math.random() < 0.5 ? "❄" : "✦";
        s.style.left = Math.random() * 100 + "vw";
        s.style.animationDuration = (5 + Math.random() * 6) + "s";
        s.style.fontSize = (12 + Math.random() * 14) + "px";
        s.style.opacity = (0.35 + Math.random() * 0.6);
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 12000);
      }, 220);
    }

    function stopSnow() {
      if (snowTimer) {
        clearInterval(snowTimer);
        snowTimer = null;
      }
      document.querySelectorAll(".snowflake").forEach(s => s.remove());
    }

    function applyTheme(theme) {
      currentTheme = theme;

      if (theme === "dark") document.documentElement.setAttribute("data-theme", "dark");
      else if (theme === "light") document.documentElement.setAttribute("data-theme", "light");
      else if (theme === "christmas") document.documentElement.setAttribute("data-theme", "christmas");
      else document.documentElement.removeAttribute("data-theme");

      document.querySelectorAll(".theme-option").forEach(opt => {
        opt.classList.toggle("active", opt.dataset.theme === theme);
      });

      // ✅ snow only on christmas theme (cover + main)
      if (theme === "christmas") startSnow();
      else stopSnow();
    }

    // ---------- Pair sync ----------
    function loadRoom() { return localStorage.getItem(KEY_ROOM) || ""; }
    function loadRoomSecret() { return localStorage.getItem(KEY_ROOM_SECRET) || ""; }

    function syncConfigured() {
      return !!(loadRoom().trim() && loadRoomSecret().trim());
    }

    function setSyncPill(text) {
      $("syncPill").textContent = text;
    }

    let suppressSync = false;
    let syncDebounce = null;

    function getLocalState() {
      return {
        active: loadActive(),
        saved: loadSaved(),
        completed: loadCompleted(),
        messages: loadMessages(),
        customTags: loadCustomTags(),
        systemMessage: loadSystemMessage(),
      };
    }

    function applyStateToLocal(state) {
      if (!state || typeof state !== "object") return;

      suppressSync = true;
      if (Array.isArray(state.active)) localStorage.setItem(KEY_ACTIVE, JSON.stringify(state.active));
      if (Array.isArray(state.saved)) localStorage.setItem(KEY_SAVED, JSON.stringify(state.saved));
      if (Array.isArray(state.completed)) localStorage.setItem(KEY_COMPLETED, JSON.stringify(state.completed));
      if (Array.isArray(state.messages)) localStorage.setItem(KEY_MESSAGES, JSON.stringify(state.messages));
      if (Array.isArray(state.customTags)) localStorage.setItem(KEY_CUSTOM_TAGS, JSON.stringify(state.customTags));
      if (typeof state.systemMessage === "string") localStorage.setItem(KEY_SYSTEM_MESSAGE, state.systemMessage);
      suppressSync = false;
    }

    async function remoteGetState() {
      const room = loadRoom().trim();
      const secret = loadRoomSecret().trim();
      const res = await fetch(`/.netlify/functions/room?room=${encodeURIComponent(room)}`, {
        headers: { "x-room-secret": secret }
      });
      if (!res.ok) throw new Error("Remote get failed");
      const data = await res.json();
      return data.payload || null;
    }

    async function remoteSetState(payload) {
      const room = loadRoom().trim();
      const secret = loadRoomSecret().trim();
      const res = await fetch(`/.netlify/functions/room`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-room-secret": secret
        },
        body: JSON.stringify({ room, payload })
      });
      if (!res.ok) throw new Error("Remote set failed");
      return true;
    }

    async function pullRemoteState() {
      if (!syncConfigured()) return;
      try {
        setSyncPill("SYNC: PULLING");
        const remote = await remoteGetState();
        if (remote && Object.keys(remote).length) {
          applyStateToLocal(remote);
          ensureCustomTagsInSelect();
          renderSystemMessage(loadSystemMessage());
          renderActive();
          renderCompleted();
          renderMessages();
          updateNotifications();
          showToast("Synced");
        }
        setSyncPill("SYNC: ON");
      } catch {
        setSyncPill("SYNC: ERROR");
      }
    }

    async function pushRemoteState() {
      if (!syncConfigured() || suppressSync) return;
      try {
        setSyncPill("SYNC: SAVING");
        await remoteSetState(getLocalState());
        setSyncPill("SYNC: ON");
      } catch {
        setSyncPill("SYNC: ERROR");
      }
    }

    function schedulePush() {
      if (!syncConfigured() || suppressSync) return;
      clearTimeout(syncDebounce);
      syncDebounce = setTimeout(pushRemoteState, 600);
    }

    async function pairPrompt() {
      const room = prompt("PAIR CODE (same for both of you):", loadRoom() || "yasir-kylee");
      if (room === null) return;

      const secret = prompt("PAIR SECRET (same for both). This must match the Netlify env COUPLE_ROOM_SECRET:", loadRoomSecret() || "");
      if (secret === null) return;

      const r = room.trim();
      const s = secret.trim();

      if (!r || !s) {
        localStorage.removeItem(KEY_ROOM);
        localStorage.removeItem(KEY_ROOM_SECRET);
        setSyncPill("SYNC: OFF");
        showToast("Pairing disabled");
        return;
      }

      localStorage.setItem(KEY_ROOM, r);
      localStorage.setItem(KEY_ROOM_SECRET, s);

      setSyncPill("SYNC: CONNECTING");

      // If room already has data, pull it. If not, push local to create it.
      try {
        const remote = await remoteGetState();
        if (remote && Object.keys(remote).length) {
          applyStateToLocal(remote);
          showToast("Pulled shared room");
        } else {
          await remoteSetState(getLocalState());
          showToast("Created shared room");
        }

        ensureCustomTagsInSelect();
        renderSystemMessage(loadSystemMessage());
        renderFromPill();
        renderActive();
        renderCompleted();
        renderMessages();
        updateNotifications();
        setSyncPill("SYNC: ON");
      } catch {
        setSyncPill("SYNC: ERROR");
        alert("Pairing failed. Make sure Netlify env vars + Supabase are set, then redeploy.");
      }
    }

    // ---------- Wire up events ----------
    $("btnOpen").addEventListener("click", openGift);
    $("btnHome").addEventListener("click", goHome);

    $("btnEditSystemMessage").addEventListener("click", () => {
      const msg = prompt("Edit system message:", loadSystemMessage());
      if (msg !== null && msg.trim()) {
        saveSystemMessage(msg.trim());
        renderSystemMessage(msg.trim());
        showToast("System message updated");
      }
    });

    $("btnPair").addEventListener("click", pairPrompt);

    $("fromPill").addEventListener("click", (e) => {
      e.stopPropagation();
      setIdentityPrompt();
    });

    $("btnAdd").addEventListener("click", () => {
      const title = $("newTitle").value.trim();
      const desc = $("newDesc").value.trim();
      const tagSelect = $("newTag");
      let tag = tagSelect.value;

      if (tag === "custom") {
        tag = $("customTagInput").value.trim() || "custom";
        const customTags = loadCustomTags();
        if (!customTags.includes(tag)) {
          customTags.push(tag);
          saveCustomTags(customTags);
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = tag;
          tagSelect.insertBefore(opt, tagSelect.lastElementChild);
        }
      }

      if (!title) return alert("Add a title first");

      const mission = { title, desc, tag, done: false };

      const active = loadActive();
      active.push(mission);
      saveActive(active);

      const saved = loadSaved();
      const isDuplicate = saved.some(s => s.title === mission.title && s.desc === mission.desc && s.tag === mission.tag);
      if (!isDuplicate) {
        saved.push(mission);
        saveSaved(saved);
      }

      $("newTitle").value = "";
      $("newDesc").value = "";
      $("newTag").value = "date";
      $("customTagInput").value = "";
      $("customTagField").classList.add("hidden");

      renderActive();
    });

    $("btnClearFields").addEventListener("click", () => {
      $("newTitle").value = "";
      $("newDesc").value = "";
      $("newTag").value = "date";
      $("customTagInput").value = "";
      $("customTagField").classList.add("hidden");
    });

    $("newTag").addEventListener("change", (e) => {
      if (e.target.value === "custom") $("customTagField").classList.remove("hidden");
      else $("customTagField").classList.add("hidden");
    });

    document.querySelectorAll(".mission-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".mission-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        if (tab.dataset.tab === "active") {
          $("activeTab").classList.remove("hidden");
          $("completedTab").classList.add("hidden");
        } else {
          $("activeTab").classList.add("hidden");
          $("completedTab").classList.remove("hidden");
        }
      });
    });

    $("btnAddSaved").addEventListener("click", () => {
      const saved = loadSaved();
      const container = $("savedMissionsList");
      container.innerHTML = "";
      selectedSavedMissions = [];

      if (saved.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); text-align: center;">No saved missions yet. Add one first!</p>';
      } else {
        saved.forEach((mission, idx) => {
          const card = document.createElement("div");
          card.className = "saved-mission-card";
          card.dataset.idx = idx;
          card.innerHTML = `
            <div class="saved-mission-header">
              <div class="itext">
                <div class="ititle">
                  <span>${escapeHtml(mission.title)}</span>
                  <span class="itag">${escapeHtml(mission.tag)}</span>
                </div>
                <p class="idesc">${escapeHtml(mission.desc || "")}</p>
              </div>
              <div class="saved-mission-actions">
                <button class="btn" data-action="select">SELECT</button>
                <button class="btn" data-action="edit">EDIT & ADD</button>
              </div>
            </div>
          `;

          card.querySelector('[data-action="select"]').addEventListener("click", () => {
            if (selectedSavedMissions.includes(idx)) {
              selectedSavedMissions = selectedSavedMissions.filter(i => i !== idx);
              card.classList.remove("selected");
            } else {
              selectedSavedMissions.push(idx);
              card.classList.add("selected");
            }
          });

          card.querySelector('[data-action="edit"]').addEventListener("click", () => {
            $("newTitle").value = mission.title;
            $("newDesc").value = mission.desc;

            const tagSelect = $("newTag");
            const hasTag = Array.from(tagSelect.options).some(opt => opt.value === mission.tag);
            if (hasTag) {
              tagSelect.value = mission.tag;
            } else {
              tagSelect.value = "custom";
              $("customTagField").classList.remove("hidden");
              $("customTagInput").value = mission.tag;
            }

            $("savedMissionsModal").classList.remove("active");
            alert("Mission loaded for editing. Click 'Add Mission' to add the edited version to Active list.");
          });

          container.appendChild(card);
        });
      }

      $("savedMissionsModal").classList.add("active");
    });

    $("btnAddSelectedMissions").addEventListener("click", () => {
      if (selectedSavedMissions.length === 0) return alert("Please select at least one mission");

      const saved = loadSaved();
      const active = loadActive();

      selectedSavedMissions.forEach(idx => {
        const mission = saved[idx];
        active.push({ ...mission, done: false });
      });

      saveActive(active);
      renderActive();
      $("savedMissionsModal").classList.remove("active");
      selectedSavedMissions = [];
    });

    $("closeSavedModal").addEventListener("click", () => {
      $("savedMissionsModal").classList.remove("active");
    });

    $("btnSaveNote").addEventListener("click", () => {
      const content = $("customNote").value.trim();
      if (!content) return alert("Write a message first");

      const from = loadIdentity();
      const timestamp = new Date().toLocaleString();
      const messages = loadMessages();
      messages.push({ from, timestamp, content, read: false });
      saveMessages(messages);

      $("customNote").value = "";
      renderMessages();
      updateNotifications();
      showToast("Letter sent");
    });

    $("envelopeBtn").addEventListener("click", () => {
      const messages = loadMessages();
      if (messages.length > 0) openMessage(messages.length - 1);
      else alert("No messages yet!");
    });

    $("notificationBell").addEventListener("click", () => {
      $("notificationDropdown").classList.toggle("active");
    });

    $("closeLetterModal").addEventListener("click", () => {
      $("letterModal").classList.remove("active");
    });

    $("btnDownloadText").addEventListener("click", () => {
      const active = loadActive();
      const completed = loadCompleted().filter(c => !c.isExample);

      const text = `kywee + yessir bucket list - 2026
====================

SYSTEM MESSAGE:
${loadSystemMessage()}

ACTIVE MISSIONS:
${active.map(i => `[ ] ${i.title} — ${i.desc} (#${i.tag})`).join("\n")}

COMPLETED MISSIONS:
${completed.map(i => `[X] ${i.title} — ${i.desc} (#${i.tag})`).join("\n")}
`;

      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kywee-yessir-bucket-list-2026.txt";
      a.click();
      URL.revokeObjectURL(url);
    });

    $("themeBtn").addEventListener("click", () => {
      $("themeDropdown").classList.toggle("active");
    });

    document.querySelectorAll(".theme-option").forEach(option => {
      option.addEventListener("click", () => {
        const theme = option.dataset.theme;
        saveTheme(theme);
        applyTheme(theme);
        $("themeDropdown").classList.remove("active");
      });
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".theme-switcher")) $("themeDropdown").classList.remove("active");
      if (!e.target.closest("#notificationBell") && !e.target.closest("#notificationDropdown")) {
        $("notificationDropdown").classList.remove("active");
      }
    });

    // Pull on focus (so if Kylee changes it, you see it when you come back)
    window.addEventListener("focus", () => {
      if (syncConfigured()) pullRemoteState();
    });

    // ---------- Init ----------
    (function init() {
      ensureCustomTagsInSelect();

      const theme = loadTheme();
      applyTheme(theme);

      const systemMessage = loadSystemMessage();
      renderSystemMessage(systemMessage);

      renderFromPill();
      updateNotifications();

      setSyncPill(syncConfigured() ? "SYNC: ON" : "SYNC: OFF");
      if (syncConfigured()) pullRemoteState();
    })();
  </script>
</body>
</html>
